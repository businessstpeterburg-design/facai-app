<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>TON Temple 7D</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; background-color: #000; overflow: hidden; font-family: sans-serif; }
        canvas { display: block; }
        #ui {
            position: absolute; bottom: 50px; width: 100%; text-align: center;
            color: #d4af37; z-index: 10; pointer-events: none;
        }
        .btn {
            pointer-events: auto; padding: 15px 30px;
            background: linear-gradient(45deg, #5d4405, #b8860b);
            border: 1px solid #d4af37; border-radius: 25px;
            color: white; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }
    </style>
</head>
<body>

    <div id="ui">
        <button class="btn" onclick="triggerAction()">ПОЛУЧИТЬ ПРЕДСКАЗАНИЕ</button>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // Инициализация Telegram
        const tg = window.Telegram.WebApp;
        tg.expand();

        let scene, camera, renderer, composer, model;

        init();
        animate();

        function init() {
            // 1. Сцена и Камера
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            scene.fog = new THREE.Fog(0x000000, 2, 10);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 4;

            // 2. Рендерер
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.toneMapping = THREE.ReinhardToneMapping;
            document.body.appendChild(renderer.domElement);

            // 3. Освещение (Золотой свет с тенями)
            const ambientLight = new THREE.AmbientLight(0x404040, 2); 
            scene.add(ambientLight);

            const pointLight = new THREE.PointLight(0xffd700, 50, 100);
            pointLight.position.set(2, 2, 2);
            scene.add(pointLight);

            // 4. Настройка Bloom (Свечение как на PS5)
            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.2;
            bloomPass.strength = 1.2; // Сила свечения
            bloomPass.radius = 0.5;

            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            // 5. Загрузка HDR Environment (Заглушка для блеска металла)
            const genCubeUrls = (prefix, postfix) => [
                prefix + 'px' + postfix, prefix + 'nx' + postfix,
                prefix + 'py' + postfix, prefix + 'ny' + postfix,
                prefix + 'pz' + postfix, prefix + 'nz' + postfix
            ];
            // Используем стандартную карту отражений для золотого блеска
            scene.environment = new THREE.CubeTextureLoader().load(genCubeUrls('https://threejs.org/examples/textures/cube/Park2/', '.jpg'));

            // 6. Загрузчик моделей (GLTF)
            const loader = new GLTFLoader();
            // ЗАМЕНИ ССЫЛКУ НИЖЕ НА СВОЙ .GLB ФАЙЛ
            const modelUrl = 'https://threejs.org/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf'; 
            
            loader.load(modelUrl, (gltf) => {
                model = gltf.scene;
                model.scale.set(1.5, 1.5, 1.5);
                scene.add(model);
            }, undefined, (error) => {
                console.error('Ошибка загрузки модели:', error);
            });

            window.addEventListener('resize', onWindowResize);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (model) {
                model.rotation.y += 0.01; // Плавное вращение
            }
            composer.render();
        }

        // Экшен при нажатии
        window.triggerAction = function() {
            // Вибрация Telegram
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('heavy');
            }
            
            // Анимация рывка при клике
            if (model) {
                model.rotation.y += 2.0;
                model.scale.set(1.7, 1.7, 1.7);
                setTimeout(() => model.scale.set(1.5, 1.5, 1.5), 100);
            }
            console.log("Предсказание активировано");
        };
    </script>
</body>
</html>
