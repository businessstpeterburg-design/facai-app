<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>TON TEMPLE / FA CAI SUPREME AI</title>

  <style>
    :root{
      --obsidian:#050505;
      --gold:#FFD36A;
      --gold2:#B8860B;
      --crimson:#B8001D;
      --warm:#FFF3D1;
      --glass: rgba(10,10,12,.52);
      --glassBorder: rgba(255,211,106,.18);
    }
    html,body{height:100%; margin:0; background:#000; overflow:hidden; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    canvas{display:block}

    /* ====== LAYERS ====== */
    #stage3d{
      position:fixed; inset:0;
      z-index:1;
      background: radial-gradient(1200px 800px at 50% 30%, #0b0e18 0%, #050507 60%, #000 100%);
      touch-action:none;
    }
    #fxCanvas{
      position:fixed; inset:0;
      z-index:3;
      pointer-events:none;
    }
    #ui{
      position:fixed; inset:0;
      z-index:5;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    .uiWrap{
      width:min(1100px, 100%);
      height:100%;
      display:flex;
      flex-direction:column;
      padding:10px;
      gap:10px;
      box-sizing:border-box;
    }

    /* ====== TOP HUD ====== */
    .topHud{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      background: linear-gradient(180deg, rgba(10,10,12,.62), rgba(10,10,12,.40));
      border:1px solid var(--glassBorder);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
      line-height:1.1;
      user-select:none;
    }
    .brand .t1{
      font-weight:700; letter-spacing:.12em; font-size:12px;
      color:var(--warm);
      text-transform:uppercase;
      opacity:.95;
    }
    .brand .t2{
      font-weight:600; letter-spacing:.16em; font-size:10px;
      color:rgba(255,211,106,.8);
      text-transform:uppercase;
    }
    .hudRight{
      display:flex; align-items:center; gap:8px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,211,106,.14);
      color: rgba(255,243,209,.92);
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      user-select:none;
      white-space:nowrap;
    }
    .btn{
      cursor:pointer;
      border:none;
      outline:none;
      padding:9px 12px;
      border-radius:999px;
      background: rgba(255,211,106,.10);
      border:1px solid rgba(255,211,106,.25);
      color: rgba(255,243,209,.95);
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      transition: transform .12s ease, background .18s ease, border-color .18s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,211,106,.14); border-color: rgba(255,211,106,.34);}
    .btn:active{ transform: translateY(0px) scale(.99); }

    /* ====== CENTER STAGE ====== */
    .center{
      flex:1;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      align-content:stretch;
    }

    .card{
      border-radius:18px;
      background: var(--glass);
      border:1px solid var(--glassBorder);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: 0 14px 55px rgba(0,0,0,.42);
      overflow:hidden;
      position:relative;
    }
    .cardInner{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .title{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      user-select:none;
    }
    .title h2{
      margin:0;
      font-size:13px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:rgba(255,243,209,.95);
      font-family: Orbitron, Inter, system-ui;
      font-weight:700;
    }
    .title .sub{
      font-size:10px;
      letter-spacing:.12em;
      color: rgba(255,211,106,.74);
      text-transform:uppercase;
      opacity:.95;
    }

    /* ====== WHEEL BUTTON ====== */
    .bigAction{
      display:flex; flex-direction:column; gap:10px;
      align-items:center; justify-content:center;
      padding:18px 14px 16px;
    }
    .wheelBtn{
      width:min(340px, 92%);
      height:58px;
      border-radius:16px;
      border:1px solid rgba(255,211,106,.28);
      background: linear-gradient(180deg, rgba(255,211,106,.16), rgba(255,211,106,.08));
      color: rgba(255,243,209,.98);
      font-size:12px;
      letter-spacing:.22em;
      text-transform:uppercase;
      font-weight:700;
      box-shadow: 0 16px 50px rgba(0,0,0,.35);
      cursor:pointer;
      transition: transform .14s ease;
    }
    .wheelBtn:hover{ transform: translateY(-1px);}
    .wheelBtn:active{ transform: translateY(0px) scale(.99);}

    .micro{
      font-size:10px;
      letter-spacing:.12em;
      color: rgba(255,243,209,.75);
      text-align:center;
      line-height:1.4;
      user-select:none;
      max-width: 620px;
    }

    /* ====== BOTTOM DOCK ====== */
    .dock{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:16px;
      background: linear-gradient(180deg, rgba(10,10,12,.54), rgba(10,10,12,.36));
      border:1px solid var(--glassBorder);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .dockLeft, .dockRight{ display:flex; gap:8px; align-items:center; }
    .dotBtn{
      width:38px; height:38px;
      border-radius:14px;
      border:1px solid rgba(255,211,106,.18);
      background: rgba(0,0,0,.22);
      color: rgba(255,243,209,.92);
      cursor:pointer;
      transition: transform .12s ease, border-color .18s ease;
      font-weight:700;
    }
    .dotBtn:hover{ transform: translateY(-1px); border-color: rgba(255,211,106,.28);}
    .dotBtn:active{ transform: translateY(0px) scale(.99); }

    /* ====== OVERLAY: PARCHMENT REVEAL ====== */
    #overlay{
      position:fixed; inset:0;
      z-index:10;
      display:none;
      align-items:center;
      justify-content:center;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    #overlay.show{ display:flex; }
    .parchmentWrap{
      width:min(760px, 96vw);
      height:min(74vh, 680px);
      position:relative;
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 25px 120px rgba(0,0,0,.6);
      border:1px solid rgba(255,211,106,.22);
      background: radial-gradient(110% 90% at 35% 25%, rgba(255,243,209,.14), rgba(0,0,0,.0) 55%),
                  linear-gradient(180deg, rgba(20,16,10,.95), rgba(10,9,8,.86));
    }
    .parchmentCanvas{
      position:absolute; inset:0;
      width:100%; height:100%;
    }
    .overlayTop{
      position:absolute; left:0; right:0; top:0;
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px;
      background: linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.0));
      z-index:2;
      pointer-events:none;
    }
    .overlayTop .label{
      font-size:10px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: rgba(255,243,209,.85);
      font-family: Orbitron, Inter, system-ui;
      pointer-events:none;
    }
    .closeBtn{
      pointer-events:auto;
      cursor:pointer;
      border:none;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,211,106,.10);
      border:1px solid rgba(255,211,106,.22);
      color: rgba(255,243,209,.95);
      font-size:10px;
      letter-spacing:.18em;
      text-transform:uppercase;
    }

    /* tiny badge */
    .premiumBadge{
      position:absolute; right:16px; top:70px;
      z-index:6;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,211,106,.10);
      border:1px solid rgba(255,211,106,.25);
      color: rgba(255,243,209,.92);
      font-size:10px;
      letter-spacing:.16em;
      text-transform:uppercase;
      display:none;
      user-select:none;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .premiumBadge.show{ display:inline-flex; align-items:center; gap:8px; }
    .premiumDot{
      width:7px;height:7px;border-radius:50%;
      background: rgba(255,211,106,.92);
      box-shadow: 0 0 18px rgba(255,211,106,.55);
    }
  </style>
</head>

<body>
  <canvas id="stage3d"></canvas>
  <canvas id="fxCanvas"></canvas>

  <div id="ui">
    <div class="uiWrap">
      <div class="topHud">
        <div class="brand">
          <div class="t1">TON TEMPLE</div>
          <div class="t2">帝王福流仪式</div>
        </div>
        <div class="hudRight">
          <div class="pill" id="qkPill">QK 000.00</div>
          <div class="pill" id="flowPill">FLOW 00/100</div>
          <button class="btn" id="helpBtn">i</button>
          <button class="btn" id="langBtn">EN</button>
          <button class="btn" id="premiumBtn">GATE</button>
        </div>
      </div>

      <div class="center">
        <div class="card">
          <div class="cardInner">
            <div class="title">
              <h2 id="titleMain">Temple Ritual</h2>
              <div class="sub" id="titleSub">Spin → Guidance → Decision</div>
            </div>

            <div class="bigAction">
              <button class="wheelBtn" id="spinBtn">SPIN WHEEL</button>
              <div class="micro" id="microText">
                This is a ritualized interface. Not financial advice.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="dock">
        <div class="dockLeft">
          <button class="dotBtn" id="journalBtn">J</button>
          <button class="dotBtn" id="proBtn">P</button>
        </div>
        <div class="dockRight">
          <button class="dotBtn" id="soundBtn">S</button>
          <button class="dotBtn" id="wishBtn">★</button>
        </div>
      </div>
    </div>
  </div>

  <div class="premiumBadge" id="premiumBadge"><span class="premiumDot"></span> PREMIUM</div>

  <!-- PARCHMENT OVERLAY -->
  <div id="overlay">
    <div class="parchmentWrap">
      <div class="overlayTop">
        <div class="label" id="overlayLabel">TEMPLE GUIDANCE</div>
        <button class="closeBtn" id="closeOverlay">CLOSE</button>
      </div>
      <canvas class="parchmentCanvas" id="parchment"></canvas>
    </div>
  </div>

  <!-- THREE (NO MODULES) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

  <script>
  (function(){
    "use strict";

    /* ===============================
       PERF GOVERNOR (Telegram-safe)
       =============================== */
    const PERF = (()=>{
      let q="high";
      const mem = navigator.deviceMemory || 4;
      const cores = navigator.hardwareConcurrency || 4;
      if(mem<=3 || cores<=4) q="medium";
      if(mem<=2) q="low";
      function dpr(){
        const cap = (q==="low") ? 1.25 : 2.0;
        return Math.min(window.devicePixelRatio||1, cap);
      }
      return {q, dpr};
    })();

    /* ===============================
       HAPTIC (Telegram + fallback)
       =============================== */
    function haptic(type="light"){
      try{
        if(window.Telegram && Telegram.WebApp && Telegram.WebApp.HapticFeedback){
          const H=Telegram.WebApp.HapticFeedback;
          if(type==="success") H.notificationOccurred("success");
          else if(type==="error") H.notificationOccurred("error");
          else H.impactOccurred(type);
          return;
        }
      }catch(e){}
      if(navigator.vibrate){
        if(type==="heavy") navigator.vibrate([25,10,25]);
        else if(type==="success") navigator.vibrate([15,10,35]);
        else navigator.vibrate(10);
      }
    }

    /* ===============================
       TEMPLE AUDIO (simple, safe)
       (no casino, quiet)
       =============================== */
    const AudioSys = (()=>{
      let ctx=null, master=null, enabled=true;
      function ensure(){
        if(!enabled) return;
        if(!ctx){
          ctx = new (window.AudioContext||window.webkitAudioContext)();
          master = ctx.createGain();
          master.gain.value=0.35;
          master.connect(ctx.destination);
        }
        if(ctx.state!=="running") ctx.resume().catch(()=>{});
      }
      const r=(a,b)=>a+Math.random()*(b-a);
      const now=()=>ctx?ctx.currentTime:0;

      function whoosh(){
        ensure(); if(!ctx) return;
        const t0=now();
        const osc=ctx.createOscillator();
        osc.type="sine";
        osc.frequency.setValueAtTime(160,t0);
        osc.frequency.exponentialRampToValueAtTime(620*r(.92,1.08),t0+.18);
        const g=ctx.createGain();
        g.gain.setValueAtTime(0.0001,t0);
        g.gain.exponentialRampToValueAtTime(0.14,t0+.04);
        g.gain.exponentialRampToValueAtTime(0.0001,t0+.22);
        osc.connect(g).connect(master);
        osc.start(t0); osc.stop(t0+.24);
      }

      function chime(){
        ensure(); if(!ctx) return;
        const t0=now();
        const freqs=[523.25,659.25,783.99].map(f=>f*r(.98,1.02));
        freqs.forEach((f,i)=>{
          const osc=ctx.createOscillator(); osc.type="sine";
          osc.frequency.setValueAtTime(f,t0);
          const g=ctx.createGain();
          g.gain.setValueAtTime(0.0001,t0);
          g.gain.exponentialRampToValueAtTime(0.10/(i+1),t0+.02);
          g.gain.exponentialRampToValueAtTime(0.0001,t0+.6);
          osc.connect(g).connect(master);
          osc.start(t0+i*0.02); osc.stop(t0+.65);
        });
      }

      function stamp(){
        ensure(); if(!ctx) return;
        const t0=now();
        const osc=ctx.createOscillator(); osc.type="sine";
        osc.frequency.setValueAtTime(110*r(.95,1.05),t0);
        osc.frequency.exponentialRampToValueAtTime(55,t0+.09);
        const g=ctx.createGain();
        g.gain.setValueAtTime(0.0001,t0);
        g.gain.exponentialRampToValueAtTime(0.22,t0+.01);
        g.gain.exponentialRampToValueAtTime(0.0001,t0+.16);
        osc.connect(g).connect(master);
        osc.start(t0); osc.stop(t0+.18);
      }

      function toggle(){
        enabled=!enabled;
        if(enabled) ensure();
        return enabled;
      }

      return {ensure, whoosh, chime, stamp, toggle};
    })();

    /* ===============================
       I18N (EN label locked)
       =============================== */
    const I18N = (()=>{
      const key="tt_lang";
      let lang=localStorage.getItem(key)||"zh";
      const dict={
        zh:{
          titleMain:"帝王福流仪式",
          titleSub:"转轮 → 指引 → 抉择",
          spin:"转动福轮",
          micro:"这是一种仪式化界面，并非金融建议。",
          overlay:"天宫指引",
          wish:"许一个愿",
          gate:"供奉",
          info:"说明",
        },
        en:{
          titleMain:"Temple Ritual",
          titleSub:"Spin → Guidance → Decision",
          spin:"SPIN WHEEL",
          micro:"This is a ritualized interface. Not financial advice.",
          overlay:"TEMPLE GUIDANCE",
          wish:"MAKE A WISH",
          gate:"GATE",
          info:"INFO",
        }
      };
      function t(k){ return (dict[lang]&&dict[lang][k]) || dict.zh[k] || k; }
      function set(n){
        lang = (n==="en") ? "en" : "zh";
        localStorage.setItem(key, lang);
        render();
      }
      function toggle(){ set(lang==="zh"?"en":"zh"); }
      function render(){
        document.documentElement.lang=lang;
        document.getElementById("titleMain").textContent=t("titleMain");
        document.getElementById("titleSub").textContent=t("titleSub");
        document.getElementById("spinBtn").textContent=t("spin");
        document.getElementById("microText").textContent=t("micro");
        document.getElementById("overlayLabel").textContent=t("overlay");
        document.getElementById("helpBtn").textContent="i";
        document.getElementById("langBtn").textContent="EN"; // LOCKED
        document.getElementById("premiumBtn").textContent = (lang==="zh") ? "供奉" : "GATE";
      }
      return {t,set,toggle,render,get:()=>lang};
    })();
    I18N.render();

    /* ===============================
       STATE (Premium + non-repeat bag)
       =============================== */
    const State = (()=>{
      const key="tt_state_v1_ps5feel";
      const base={ qk:0, flow:50, lastSpinDay:"", premiumUntil:0, predBag:[] };
      const now=()=>Date.now();
      let s;
      try{ s=Object.assign({}, base, JSON.parse(localStorage.getItem(key)||"null")||{}); }
      catch(e){ s=Object.assign({}, base); }
      function save(){ localStorage.setItem(key, JSON.stringify(s)); }
      function isPremium(){ return s.premiumUntil>now(); }
      function addPremium(h=24){ s.premiumUntil=now()+h*3600*1000; save(); }
      function addQK(v){ s.qk=Math.max(0, Math.round((s.qk+v)*100)/100); save(); }
      function setFlow(v){ s.flow=Math.max(0, Math.min(100, Math.round(v))); save(); }
      function spunToday(){
        const d=new Date(); const k=`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
        return s.lastSpinDay===k;
      }
      function markSpinToday(){
        const d=new Date(); const k=`${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
        s.lastSpinDay=k; save();
      }
      function ensureBag(n=100){
        if(!Array.isArray(s.predBag) || s.predBag.length===0){
          const ids=[...Array(n)].map((_,i)=>i);
          for(let i=ids.length-1;i>0;i--){
            const j=Math.floor(Math.random()*(i+1));
            [ids[i],ids[j]]=[ids[j],ids[i]];
          }
          s.predBag=ids; save();
        }
      }
      function popId(n=100){
        ensureBag(n);
        const id=s.predBag.pop();
        save();
        return id;
      }
      return {s,save,isPremium,addPremium,addQK,setFlow,spunToday,markSpinToday,popId};
    })();

    function renderHUD(){
      document.getElementById("qkPill").textContent = `QK ${State.s.qk.toFixed(2)}`;
      document.getElementById("flowPill").textContent = `FLOW ${String(State.s.flow).padStart(2,"0")}/100`;
      const badge=document.getElementById("premiumBadge");
      if(State.isPremium()) badge.classList.add("show"); else badge.classList.remove("show");
    }
    renderHUD();

    /* ===============================
       100 Predictions (EN/ZH), 5+ sentences each
       No “signals”, no profit promises.
       =============================== */
    function buildPredictions(){
      const enBases=[
        "Today is about returning to calm. Spend more time with family or people who steady you. Keep your schedule light and protect your attention. Do one meaningful task, then stop and rest. Your best results arrive when you choose harmony over pressure.",
        "Treat today like a reset. Walk more, breathe slower, and reduce noise from messages and arguments. If you feel tension, soften your body before you answer anyone. Spend time with someone you trust, even briefly. Simplicity is your strongest strategy today.",
        "You have enough strength for the day, but pacing matters. Avoid rushing into promises or dramatic decisions. Choose one priority and finish it carefully. Then allow yourself real recovery time. Quiet consistency will bring you forward.",
        "Today favors connection over confrontation. Keep your words fewer and kinder, especially when you feel irritated. Move your body to release stress and clear your mind. A small new experience can refresh your mood. Your flow grows when you stay grounded.",
        "There is a quiet luck in the day, but it appears only when your mind is steady. Don’t chase chaos and don’t force outcomes. Spend time with supportive people and keep your environment clean. Pause before reacting to pressure. Peace is your advantage."
      ];
      const enCautionBases=[
        "Today may test your patience, so slow down on purpose. Avoid impulsive spending, sharp words, or risky shortcuts. If information feels confusing, wait and verify instead of guessing. Spend time with family or close friends to stabilize your emotions. Calm discipline will protect your path.",
        "Be careful with overstimulation today. Too many messages and demands can create unnecessary anxiety. Step back, do one simple task, and then breathe. Don’t argue to win—choose quiet boundaries. The day becomes smoother when you refuse chaos."
      ];

      const zhBases=[
        "今天适合回到稳定与温柔。多陪伴家人或让你安心的人，把节奏放慢。减少噪音：少争辩、少冲动决定、少情绪波动。选择一件小事认真完成，然后允许自己休息。你越平静，指引越清晰。",
        "把今天当作一次柔和的重启。多走路、多喝水，让身体先安定下来。遇到压力不要硬扛，先把呼吸放深。与亲近的人短暂相聚，会让你的心回到正位。保持和气，福流自然来。",
        "今天你的力量足够，但关键在于分配。不要一次扛太多任务，先完成最重要的一件。若出现机会，先冷静观察再行动，不必急着证明什么。安排一点真正的休息时间，哪怕只是安静的一小时。稳定就是胜利。",
        "今天适合连接，不适合对抗。若情绪紧绷，就去走一走、伸展一下，让心慢下来。讲话少一点、语气柔一点，你会更有掌控感。把环境整理干净，外在秩序会带来内在秩序。你不需要强推结果。",
        "今天有一种“安静的好运”。它不会喧哗，只会出现在你留心的细节里。保持轻松，别把自己逼到极限。多陪伴亲近的人，让心回到柔软的位置。你越和谐，越容易看到新的出口。"
      ];
      const zhCautionBases=[
        "今天可能考验耐心，所以建议你比平时更慢一些。避免冲动承诺或情绪化决定，先让心安定。若外界压力很大，就拉开距离，给自己一点空白。与家人或可信的人相处，会让你稳定下来。平静是最好的保护。",
        "今天容易被信息和情绪过度刺激。别让太多消息把你拖进焦虑里，先回到简单的一件事。避免尖锐的语言，因为它会留下回声。保持规律、早点休息、少一点冲突。守住节奏，你就守住了福流。"
      ];

      function expandTo100(bases, cautionBases){
        const out=[];
        // 90/10 distribution
        for(let i=0;i<90;i++){
          const b=bases[i % bases.length];
          out.push(variantText(b,i));
        }
        for(let i=0;i<10;i++){
          const b=cautionBases[i % cautionBases.length];
          out.push(variantText(b,100+i));
        }
        // shuffle stable
        for(let i=out.length-1;i>0;i--){
          const j=Math.floor(Math.random()*(i+1));
          [out[i],out[j]]=[out[j],out[i]];
        }
        return out;
      }

      function variantText(t,i){
        // tiny variation without breaking sentence count
        const tail = (i%3===0)
          ? " Keep your mind clean and your tone calm. You will feel lighter by evening."
          : (i%3===1)
            ? " Choose rest when you can, and do not force answers. Let the day breathe."
            : " Trust small steps and stable people. That is how you win today.";
        // Ensure 5+ sentences by adding tail as 2 sentences
        return t + tail;
      }

      const en = expandTo100(enBases, enCautionBases);
      const zh = expandTo100(zhBases, zhCautionBases);

      return {en, zh};
    }
    const PRED = buildPredictions();

    function nextPrediction(){
      const id = State.popId(100);
      const lang = I18N.get();
      const text = (lang==="en") ? PRED.en[id] : PRED.zh[id];
      return {id,text};
    }

    /* ===============================
       OVERLAY PARCHMENT (ink writing)
       =============================== */
    const Overlay = (()=>{
      const overlay=document.getElementById("overlay");
      const close=document.getElementById("closeOverlay");
      const c=document.getElementById("parchment");
      const ctx=c.getContext("2d");

      function show(){ overlay.classList.add("show"); resize(); }
      function hide(){ overlay.classList.remove("show"); }
      close.addEventListener("click", hide);

      function resize(){
        const dpr = PERF.dpr();
        const rect=c.getBoundingClientRect();
        c.width=Math.floor(rect.width*dpr);
        c.height=Math.floor(rect.height*dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      window.addEventListener("resize", ()=>{ if(overlay.classList.contains("show")) resize(); });

      function paperBG(){
        const w=c.getBoundingClientRect().width;
        const h=c.getBoundingClientRect().height;
        ctx.clearRect(0,0,w,h);

        const g=ctx.createLinearGradient(0,0,w,h);
        g.addColorStop(0,"rgba(210,180,125,0.20)");
        g.addColorStop(0.4,"rgba(125,95,60,0.22)");
        g.addColorStop(1,"rgba(55,40,25,0.34)");
        ctx.fillStyle=g; ctx.fillRect(0,0,w,h);

        ctx.save();
        ctx.globalCompositeOperation="multiply";
        const v=ctx.createRadialGradient(w*0.5,h*0.45,30,w*0.5,h*0.45,Math.max(w,h)*0.75);
        v.addColorStop(0,"rgba(0,0,0,0)");
        v.addColorStop(1,"rgba(0,0,0,0.78)");
        ctx.fillStyle=v; ctx.fillRect(0,0,w,h);
        ctx.restore();

        // fibers
        ctx.save();
        ctx.globalAlpha=0.14;
        for(let i=0;i<140;i++){
          const y=Math.random()*h;
          ctx.strokeStyle="rgba(255,243,209,0.10)";
          ctx.lineWidth=1;
          ctx.beginPath();
          ctx.moveTo(0,y);
          ctx.lineTo(w,y+(Math.random()*8-4));
          ctx.stroke();
        }
        ctx.restore();
      }

      function drawSeal(x,y,scale){
        ctx.save();
        ctx.translate(x,y);
        ctx.rotate(-0.06);
        ctx.scale(scale,scale);

        const s=96;
        ctx.shadowColor="rgba(0,0,0,0.35)";
        ctx.shadowBlur=14;
        ctx.fillStyle="rgba(184,0,29,0.92)";
        ctx.fillRect(-s/2,-s/2,s,s);
        ctx.shadowBlur=0;

        ctx.strokeStyle="rgba(255,211,106,0.20)";
        ctx.lineWidth=2;
        ctx.strokeRect(-s/2,-s/2,s,s);

        ctx.fillStyle="rgba(255,243,209,0.92)";
        ctx.font="700 44px serif";
        ctx.textAlign="center"; ctx.textBaseline="middle";
        ctx.fillText("财",0,3);
        ctx.restore();
      }

      function wrapText(text, font, maxW){
        ctx.font=font;
        const isZH = (I18N.get()==="zh");
        const tokens = isZH ? text.split("") : text.split(" ");
        const lines=[];
        let line="";
        for(let i=0;i<tokens.length;i++){
          const add = isZH ? tokens[i] : (tokens[i]+" ");
          const test=line+add;
          if(ctx.measureText(test).width>maxW && line.length>0){
            lines.push(line);
            line=add;
          }else{
            line=test;
          }
        }
        if(line.trim().length) lines.push(line);
        return lines;
      }

      async function play(text){
        show();
        resize();
        AudioSys.ensure();
        paperBG();

        const w=c.getBoundingClientRect().width;
        const h=c.getBoundingClientRect().height;

        // header
        ctx.save();
        ctx.fillStyle="rgba(255,243,209,0.88)";
        ctx.font="700 14px Inter, system-ui";
        ctx.fillText(I18N.get()==="zh" ? "天宫指引" : "TEMPLE GUIDANCE", 26, 32);
        ctx.restore();

        const padX=32;
        const topY=70;
        const maxW=w-padX*2;

        const bodyFont = (I18N.get()==="zh")
          ? "600 18px 'Noto Sans SC','PingFang SC','Microsoft YaHei',serif"
          : "600 17px 'Georgia','Times New Roman',serif";

        const lines=wrapText(text, bodyFont, maxW);

        // ink reveal: per char
        ctx.textBaseline="top";
        let y=topY;
        let charCount=0;

        AudioSys.whoosh();

        for(let li=0; li<lines.length; li++){
          const L=lines[li];
          let x=padX;

          for(let ci=0; ci<L.length; ci++){
            const ch=L[ci];
            // brush-ish gradient
            const ink=ctx.createLinearGradient(x,y,x,y+22);
            ink.addColorStop(0,"rgba(255,243,209,0.92)");
            ink.addColorStop(1,"rgba(255,211,106,0.68)");
            ctx.fillStyle=ink;
            ctx.font=bodyFont;

            const jx=(Math.random()*0.6-0.3);
            const jy=(Math.random()*0.6-0.3);
            ctx.fillText(ch, x+jx, y+jy);

            x += ctx.measureText(ch).width;
            charCount++;
            // speed safe
            if(charCount%28===0) AudioSys.chime(); // very rare
            await sleep(10);
          }

          y += 26;
          if(y>h-130) break;
        }

        // footer
        ctx.save();
        ctx.fillStyle="rgba(255,211,106,0.70)";
        ctx.font="600 12px Inter, system-ui";
        ctx.fillText(new Date().toLocaleString(I18N.get()==="zh"?"zh-CN":"en-US"), padX, h-40);
        ctx.restore();

        // stamp
        await sleep(280);
        AudioSys.stamp();
        haptic("heavy");
        FX.dustBurst();

        const sx=w-110, sy=h-120;
        for(let k=0;k<=18;k++){
          const t=k/18;
          const ease=1-Math.pow(1-t,3);
          paperBG();

          // header redraw
          ctx.save();
          ctx.fillStyle="rgba(255,243,209,0.88)";
          ctx.font="700 14px Inter, system-ui";
          ctx.fillText(I18N.get()==="zh" ? "天宫指引" : "TEMPLE GUIDANCE", 26, 32);
          ctx.restore();

          // full text redraw
          ctx.save();
          ctx.fillStyle="rgba(255,243,209,0.92)";
          ctx.font=bodyFont;
          ctx.textBaseline="top";
          let yy=topY;
          for(let li=0; li<lines.length; li++){
            ctx.fillText(lines[li], padX, yy);
            yy += 26;
            if(yy>h-130) break;
          }
          ctx.restore();

          // footer redraw
          ctx.save();
          ctx.fillStyle="rgba(255,211,106,0.70)";
          ctx.font="600 12px Inter, system-ui";
          ctx.fillText(new Date().toLocaleString(I18N.get()==="zh"?"zh-CN":"en-US"), padX, h-40);
          ctx.restore();

          drawSeal(sx, sy, 0.55+0.45*ease);
          await raf();
        }
      }

      return {play,hide,show};
    })();

    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    function raf(){ return new Promise(r=>requestAnimationFrame(r)); }

    /* ===============================
       FX CANVAS: gold dust
       =============================== */
    const FX = (()=>{
      const fxC=document.getElementById("fxCanvas");
      const fx=fxC.getContext("2d");
      const parts=[];
      function resize(){
        const dpr=PERF.dpr();
        fxC.width=Math.floor(innerWidth*dpr);
        fxC.height=Math.floor(innerHeight*dpr);
        fxC.style.width=innerWidth+"px";
        fxC.style.height=innerHeight+"px";
        fx.setTransform(dpr,0,0,dpr,0,0);
      }
      resize();
      window.addEventListener("resize", resize);

      function spawn(initial=false,boost=1){
        parts.push({
          x:Math.random()*innerWidth,
          y: initial ? Math.random()*innerHeight : innerHeight+10,
          vx:(-0.05+Math.random()*0.10)*boost,
          vy:(-0.18+Math.random()*0.14)*boost,
          r:0.6+Math.random()*2.0,
          a:0.08+Math.random()*0.34,
          tw:0.65+Math.random()*0.35,
        });
      }
      const baseCount = (PERF.q==="low")?80:(PERF.q==="medium"?120:150);
      for(let i=0;i<baseCount;i++) spawn(true);

      function dustBurst(){
        const n=(PERF.q==="low")?18:30;
        for(let i=0;i<n;i++) spawn(false,1.8);
      }

      function step(dt){
        fx.fillStyle="rgba(0,0,0,0.18)";
        fx.fillRect(0,0,innerWidth,innerHeight);

        fx.save();
        fx.globalCompositeOperation="lighter";
        for(let i=parts.length-1;i>=0;i--){
          const p=parts[i];
          p.x += p.vx*(dt*60);
          p.y += p.vy*(dt*60);
          const tw=0.65+0.35*Math.sin(Date.now()*0.002*p.tw);
          const a=p.a*tw;

          fx.beginPath();
          fx.fillStyle=`rgba(255,211,106,${a})`;
          fx.shadowColor="rgba(255,211,106,0.35)";
          fx.shadowBlur=12;
          fx.arc(p.x,p.y,p.r,0,Math.PI*2);
          fx.fill();

          if(p.y<-20 || p.x<-30 || p.x>innerWidth+30){
            parts.splice(i,1);
            spawn(true);
          }
        }
        fx.restore();
      }

      return {step,dustBurst,resize};
    })();

    /* ===============================
       THREE SCENE (PS5-feel in web)
       - no modules
       - no postprocessing (Telegram-safe)
       - fake bloom via emissive + additive sprites
       =============================== */
    const stage=document.getElementById("stage3d");
    const renderer=new THREE.WebGLRenderer({
      canvas:stage,
      antialias:true,
      alpha:true,
      powerPreference:"high-performance"
    });
    renderer.setPixelRatio(PERF.dpr());
    renderer.setSize(innerWidth, innerHeight, false);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.05;

    const scene=new THREE.Scene();
    scene.fog=new THREE.FogExp2(0x000000, 0.0012);

    const camera=new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 3000);
    camera.position.set(0, 0, 26);

    // Lights
    const key=new THREE.DirectionalLight(0xFFD36A, 1.35);
    key.position.set(12,10,18);
    scene.add(key);

    const rim=new THREE.DirectionalLight(0xB8001D, 0.55);
    rim.position.set(-14,6,-6);
    scene.add(rim);

    scene.add(new THREE.AmbientLight(0x0b0e18, 1.15));

    // Portal ring
    const portal=new THREE.Group();
    scene.add(portal);

    const ringGeo=new THREE.TorusGeometry(8.5, 0.22, 28, 180);
    const ringMat=new THREE.MeshStandardMaterial({
      color:0xFFD36A,
      metalness:0.9,
      roughness:0.22,
      emissive:new THREE.Color(0xFFD36A),
      emissiveIntensity:0.45
    });
    const ring=new THREE.Mesh(ringGeo, ringMat);
    ring.rotation.x=Math.PI/2;
    portal.add(ring);

    const coreGeo=new THREE.CircleGeometry(8.2, 96);
    const coreMat=new THREE.MeshBasicMaterial({
      color:0x050507,
      transparent:true,
      opacity:0.18
    });
    const core=new THREE.Mesh(coreGeo, coreMat);
    core.rotation.x=Math.PI/2;
    portal.add(core);

    portal.position.set(0,-1.2,-10);

    // Stars (Points)
    function makeStars(count){
      const geo=new THREE.BufferGeometry();
      const pos=new Float32Array(count*3);
      const col=new Float32Array(count*3);
      for(let i=0;i<count;i++){
        const rr=450+Math.random()*900;
        const theta=Math.random()*Math.PI*2;
        const phi=Math.acos(2*Math.random()-1);
        const x=rr*Math.sin(phi)*Math.cos(theta);
        const y=rr*Math.sin(phi)*Math.sin(theta);
        const z=rr*Math.cos(phi);
        pos[i*3]=x; pos[i*3+1]=y; pos[i*3+2]=z;

        const warm=Math.random()<0.28;
        const c=warm?new THREE.Color(0xFFD36A):new THREE.Color(0xCFE8FF);
        const k=warm?(0.6+Math.random()*0.4):(0.55+Math.random()*0.45);
        col[i*3]=c.r*k; col[i*3+1]=c.g*k; col[i*3+2]=c.b*k;
      }
      geo.setAttribute("position", new THREE.BufferAttribute(pos,3));
      geo.setAttribute("color", new THREE.BufferAttribute(col,3));
      const mat=new THREE.PointsMaterial({
        size:(PERF.q==="low")?1.0:1.35,
        vertexColors:true,
        transparent:true,
        opacity:0.92,
        depthWrite:false
      });
      return new THREE.Points(geo,mat);
    }
    const starCount=(PERF.q==="low")?4500:(PERF.q==="medium"?9000:14000);
    const stars=makeStars(starCount);
    scene.add(stars);

    // Wish Star (small bright sprite-like)
    const wishGeo=new THREE.SphereGeometry(0.08, 10, 10);
    const wishMat=new THREE.MeshBasicMaterial({color:0xFFF3D1, transparent:true, opacity:0.0});
    const wishStar=new THREE.Mesh(wishGeo, wishMat);
    scene.add(wishStar);

    // Dragon plane (with subtle breathing)
    const texLoader=new THREE.TextureLoader();
    const dragonTex=texLoader.load("./dragon.jpg");
    dragonTex.colorSpace = THREE.SRGBColorSpace;

    const dragonGeo=new THREE.PlaneGeometry(18,18, 48,48);
    const dragonMat=new THREE.ShaderMaterial({
      transparent:true,
      uniforms:{
        uTex:{value:dragonTex},
        uTime:{value:0},
        uAura:{value:0.55}
      },
      vertexShader:`
        varying vec2 vUv;
        uniform float uTime;
        void main(){
          vUv=uv;
          vec3 p=position;
          float w = sin(uTime*1.2 + p.y*0.6) * 0.06;
          p.z += w * (0.5 + (1.0-uv.y));
          gl_Position = projectionMatrix * modelViewMatrix * vec4(p,1.0);
        }
      `,
      fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D uTex;
        uniform float uTime;
        uniform float uAura;
        void main(){
          vec4 tex = texture2D(uTex, vUv);
          float edge = smoothstep(0.0, 0.10, vUv.x) *
                       smoothstep(0.0, 0.10, vUv.y) *
                       smoothstep(0.0, 0.10, 1.0-vUv.x) *
                       smoothstep(0.0, 0.10, 1.0-vUv.y);
          float pulse = 0.5 + 0.5*sin(uTime*1.4);
          vec3 gold = vec3(1.0, 0.83, 0.42);
          vec3 glow = gold * (uAura * (0.35 + 0.65*pulse)) * (1.0-edge);

          float v = smoothstep(0.9, 0.2, distance(vUv, vec2(0.5)));
          vec3 col = tex.rgb + glow * 0.65;
          col *= (0.85 + 0.15*v);

          float a = tex.a;
          if(a < 0.01) a = 0.98; // jpg no alpha
          gl_FragColor = vec4(col, a);
        }
      `
    });
    const dragon=new THREE.Mesh(dragonGeo, dragonMat);
    dragon.position.set(0, 1.2, -16);
    scene.add(dragon);

    // Parallax
    let tx=0, ty=0, cx=0, cy=0;
    function onMove(x,y){
      tx = (x/innerWidth)*2 - 1;
      ty = (y/innerHeight)*2 - 1;
    }
    addEventListener("mousemove",(e)=>onMove(e.clientX,e.clientY),{passive:true});
    addEventListener("touchmove",(e)=>{
      const t=e.touches && e.touches[0]; if(!t) return;
      onMove(t.clientX,t.clientY);
    },{passive:true});

    // Dolly win trigger
    let dolly=0;

    function cameraDollyWin(){
      dolly=1;
    }

    async function wishMoment(){
      AudioSys.ensure();
      haptic("light");

      const micro=document.getElementById("microText");
      const prev=micro.textContent;
      micro.textContent = (I18N.get()==="zh")
        ? "许一个愿。保持安静，听见内心。"
        : "Make a wish. Stay quiet and listen within.";

      // shoot
      const start = new THREE.Vector3(-18, 10, -30);
      const end   = new THREE.Vector3( 16, -6, -6);
      wishStar.position.copy(start);
      wishStar.material.opacity=0.0;

      const t0=performance.now();
      const dur=1100;

      AudioSys.whoosh();

      while(performance.now()-t0 < dur){
        const t=(performance.now()-t0)/dur;
        const ease = t<0.5 ? 2*t*t : 1 - Math.pow(-2*t+2,2)/2;
        wishStar.position.lerpVectors(start,end,ease);
        wishStar.material.opacity = Math.min(1, ease*1.3);
        ringMat.emissiveIntensity = 0.45 + 0.55*Math.sin(ease*Math.PI);
        await raf();
      }

      AudioSys.chime();
      FX.dustBurst();
      wishStar.material.opacity=0.0;
      ringMat.emissiveIntensity=0.45;

      setTimeout(()=>micro.textContent=prev, 1400);
    }

    // Resize
    function resize3d(){
      renderer.setPixelRatio(PERF.dpr());
      renderer.setSize(innerWidth, innerHeight, false);
      camera.aspect=innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      FX.resize();
    }
    addEventListener("resize", resize3d);

    // Loop
    let last=performance.now();
    let time=0;
    function loop(){
      requestAnimationFrame(loop);
      const now=performance.now();
      const dt=Math.min(0.033,(now-last)/1000);
      last=now;
      time += dt;

      // parallax smooth
      cx += (tx-cx)*0.06;
      cy += (ty-cy)*0.06;
      camera.rotation.y = cx*0.10;
      camera.rotation.x = -cy*0.07;

      // dolly win
      if(dolly>0){
        dolly -= dt*1.35;
        const k=Math.max(0,dolly);
        const ease = 1 - Math.pow(k,2.2);
        camera.position.z = 26 - ease*2.6;
        camera.position.y = ease*0.35;
        ringMat.emissiveIntensity = 0.45 + ease*0.65;
        renderer.toneMappingExposure = 1.05 + ease*0.20;
      }else{
        camera.position.z += (26-camera.position.z)*0.06;
        camera.position.y += (0-camera.position.y)*0.06;
        ringMat.emissiveIntensity += (0.45-ringMat.emissiveIntensity)*0.06;
        renderer.toneMappingExposure += (1.05-renderer.toneMappingExposure)*0.06;
      }

      // animate scene
      dragonMat.uniforms.uTime.value=time;
      ring.rotation.z += dt*0.08;
      coreMat.opacity = 0.16 + 0.04*Math.sin(time*0.9);
      stars.rotation.y += dt*0.012;
      stars.rotation.x += dt*0.006;

      // FX
      FX.step(dt);

      renderer.render(scene,camera);
    }
    loop();

    /* ===============================
       UI EVENTS
       =============================== */
    document.getElementById("soundBtn").addEventListener("click", ()=>{
      AudioSys.ensure();
      const on=AudioSys.toggle();
      document.getElementById("soundBtn").textContent = on ? "S" : "×";
    });

    document.getElementById("langBtn").addEventListener("click", ()=>{
      I18N.toggle(); // EN label stays EN
    });

    document.getElementById("helpBtn").addEventListener("click", ()=>{
      AudioSys.ensure(); AudioSys.chime();
      const msg = (I18N.get()==="zh")
        ? "三步：转轮 → 得到指引 → 做出选择。保持平静，守住节奏。"
        : "Three steps: Spin → Guidance → Decision. Keep calm and protect your rhythm.";
      Overlay.play(msg);
    });

    document.getElementById("wishBtn").addEventListener("click", ()=>{
      wishMoment();
    });

    document.getElementById("premiumBtn").addEventListener("click", ()=>{
      // STUB: здесь подключишь TonConnect
      // Сейчас — демо активация Premium на 24ч
      AudioSys.ensure(); AudioSys.chime();
      State.addPremium(24);
      renderHUD();
      const txt = (I18N.get()==="zh")
        ? "供奉已记录。接下来 24 小时为「尊享」状态。保持温柔与自律，福流会回应你。"
        : "Offering recorded. You are Premium for the next 24 hours. Stay calm, stay disciplined, and your flow will respond.";
      Overlay.play(txt);
    });

    document.getElementById("spinBtn").addEventListener("click", async ()=>{
      AudioSys.ensure();

      if(State.spunToday() && !State.isPremium()){
        const warn = (I18N.get()==="zh")
          ? "今日已转轮。保持节制，明日再来。若需要更多指引，可通过供奉开启尊享。"
          : "You already spun today. Keep discipline and return tomorrow. If you need more guidance, unlock Premium through the Gate.";
        Overlay.play(warn);
        return;
      }

      haptic("heavy");
      AudioSys.whoosh();

      // short ritual build
      const t0=performance.now();
      const dur=900;
      while(performance.now()-t0 < dur){
        const t=(performance.now()-t0)/dur;
        ringMat.emissiveIntensity = 0.45 + t*0.85;
        portal.position.y = -1.2 + Math.sin(t*Math.PI)*0.35;
        await raf();
      }
      portal.position.y=-1.2;

      // result
      const qkGain = 3 + Math.floor(Math.random()*10);
      State.addQK(qkGain);
      State.setFlow(State.s.flow + (Math.random()*8-3));
      State.markSpinToday();
      renderHUD();

      // win moment
      cameraDollyWin();
      AudioSys.chime();
      FX.dustBurst();

      // reveal
      await sleep(220);
      const {text}=nextPrediction();
      Overlay.play(text);
    });

    // minimal placeholders for dock buttons
    document.getElementById("journalBtn").addEventListener("click", ()=>{
      AudioSys.ensure(); AudioSys.chime();
      Overlay.play(I18N.get()==="zh"
        ? "日志模块：下一 шаг会把每次指引与选择记录 7 天。"
        : "Journal module: next step will store guidance + decision for 7 days."
      );
    });
    document.getElementById("proBtn").addEventListener("click", ()=>{
      AudioSys.ensure(); AudioSys.chime();
      Overlay.play(I18N.get()==="zh"
        ? "PRO 面板：下一 шаг会显示 Flow / Risk Aura / Weather 等数据。"
        : "PRO panel: next step will show Flow / Risk Aura / Weather and more."
      );
    });

    // intro
    window.addEventListener("load", ()=>{
      setTimeout(()=>{
        AudioSys.ensure();
        AudioSys.whoosh();
      }, 220);
    });

  })();
  </script>
</body>
</html>
