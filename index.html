<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>TON Temple ‚Äî Imperial Ritual</title>

  <style>
    :root{
      --bg0:#040404;
      --bg1:#0a0704;
      --gold:#ffd36a;
      --gold2:#b8860b;
      --red:#b4001d;
      --red2:#ff2b3f;
      --glass: rgba(255,255,255,.06);
      --line: rgba(255,211,106,.22);
      --muted: rgba(255,255,255,.70);
      --danger:#ff4d4d;
      --ok:#43ffb3;
      --shadow: 0 20px 70px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:#fff;
      background:
        radial-gradient(1200px 900px at 50% 20%, rgba(255,211,106,.12), transparent 55%),
        radial-gradient(900px 700px at 15% 65%, rgba(255,43,63,.10), transparent 60%),
        radial-gradient(900px 700px at 85% 70%, rgba(180,0,29,.10), transparent 60%),
        radial-gradient(1200px 900px at 50% 85%, rgba(255,211,106,.06), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
    }

    /* FX layers never catch clicks */
    #fxDust, #fxMeteors{
      position:fixed; inset:0; width:100%; height:100%;
      pointer-events:none; z-index:0;
      opacity:.95;
    }
    #fxMeteors{opacity:.75; mix-blend-mode: screen;}

    #webglRoot{
      position:fixed; inset:0;
      z-index:0; pointer-events:none;
    }
    #webgl{width:100%;height:100%;display:block}
    #webglVignette{
      position:absolute; inset:0; pointer-events:none;
      background:
        radial-gradient(60% 50% at 50% 30%, rgba(255,211,106,.10), rgba(0,0,0,0) 55%),
        radial-gradient(80% 60% at 50% 70%, rgba(255,43,63,.06), rgba(0,0,0,0) 60%),
        linear-gradient(to bottom, rgba(0,0,0,.45), rgba(0,0,0,.65));
      mix-blend-mode: screen;
      opacity:.85;
    }

    .flash{
      position:fixed; inset:0;
      z-index:60; pointer-events:none;
      opacity:0;
      background:
        radial-gradient(800px 500px at 55% 45%, rgba(255,211,106,.35), transparent 60%),
        radial-gradient(900px 700px at 50% 60%, rgba(255,43,63,.18), transparent 65%);
      transition: opacity .15s ease;
      mix-blend-mode: screen;
    }
    .flash.on{opacity:1}

    .app{
      position:relative;
      z-index:10;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* TOPBAR */
    .topbar{
      position:sticky;
      top:0;
      z-index:90; /* ALWAYS above bang */
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.35));
      border-bottom: 1px solid rgba(255,211,106,.14);
    }
    .topbar-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      max-width:1100px;
      margin:0 auto;
    }

    .brand{display:flex;align-items:center;gap:10px;min-width: 220px;}
    .sigil{
      width:38px;height:38px;border-radius:14px;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.30), transparent 45%),
        linear-gradient(135deg, rgba(255,211,106,.85), rgba(184,134,11,.55));
      box-shadow: 0 0 0 1px rgba(255,211,106,.28), 0 18px 50px rgba(255,211,106,.12);
      position:relative; overflow:hidden;
    }
    .sigil:after{
      content:"Ë≤°";
      position:absolute; inset:0;
      display:grid; place-items:center;
      font-weight:900; color:#1a1406; font-size:20px;
      text-shadow: 0 1px 0 rgba(255,255,255,.25);
    }
    .brand-text{display:flex;flex-direction:column;line-height:1.05}
    .brand-text .t1{font-size:12px;letter-spacing:.38em;color: rgba(255,211,106,.95);text-transform:uppercase;}
    .brand-text .t2{font-size:12px;color: rgba(255,255,255,.75);}

    .top-controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,211,106,.16);
      box-shadow: 0 10px 30px rgba(0,0,0,.30);
    }
    .pill b{color: rgba(255,211,106,.96)}
    .pill .small{font-size:12px;color:rgba(255,255,255,.70)}

    .btn{
      appearance:none;
      border:none;
      border-radius:14px;
      padding:12px 14px;
      font-weight:800;
      color:#170f04;
      background: linear-gradient(135deg, rgba(255,211,106,.98), rgba(184,134,11,.86));
      box-shadow: 0 18px 50px rgba(255,211,106,.14);
      cursor:pointer;
      transition: transform .15s ease, filter .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{transform: translateY(1px) scale(.99); filter:brightness(.98)}
    .btn.secondary{
      color:#fff;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,211,106,.18);
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      font-weight:800;
    }
    .btn.ghost{
      color: rgba(255,255,255,.88);
      background: transparent;
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
      font-weight:800;
    }
    .btn.danger{
      color:#fff;
      background: linear-gradient(135deg, rgba(255,43,63,.92), rgba(180,0,29,.92));
      box-shadow: 0 18px 50px rgba(255,43,63,.10);
    }
    .btn:disabled{opacity:.42;cursor:not-allowed;filter: grayscale(.25);transform:none;}

    .toggle{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,211,106,.16);
    }
    .seg{
      display:flex;border-radius:999px;overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
    }
    .seg button{
      border:none;
      padding:9px 10px;
      font-weight:900;
      cursor:pointer;
      color: rgba(255,255,255,.74);
      background: transparent;
    }
    .seg button.active{
      color:#1a1406;
      background: linear-gradient(135deg, rgba(255,211,106,.98), rgba(184,134,11,.86));
    }

    .wrap{
      max-width:1100px;
      width:100%;
      margin:0 auto;
      padding: 18px 14px 110px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    /* ===== Dragon 3D scene (NEW) ===== */
    .dragonCard{
      border-radius:26px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.035));
      border:1px solid rgba(255,211,106,.16);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .dragonCard:before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(900px 340px at 50% 20%, rgba(255,211,106,.18), transparent 60%),
        radial-gradient(900px 520px at 50% 75%, rgba(255,43,63,.10), transparent 62%);
      pointer-events:none;
      opacity:.9;
    }
    .dragonInner{
      position:relative;
      z-index:2;
      padding:16px;
    }
    .dragonHead{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .dragonHead h2{
      margin:0;
      font-size:16px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: rgba(255,211,106,.92);
    }
    .sub{font-size:12px;color:rgba(255,255,255,.68)}

    .dragonScene{
      width:100%;
      height: min(52vh, 520px);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
      display:grid;
      place-items:center;
      perspective: 1100px;
    }

    /* subtle star noise */
    .dragonScene:before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.22), transparent 60%),
        radial-gradient(1px 1px at 30% 70%, rgba(255,255,255,.16), transparent 60%),
        radial-gradient(1px 1px at 80% 35%, rgba(255,255,255,.18), transparent 60%),
        radial-gradient(1px 1px at 60% 85%, rgba(255,255,255,.14), transparent 60%),
        radial-gradient(1px 1px at 55% 40%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(1px 1px at 15% 85%, rgba(255,255,255,.12), transparent 60%);
      opacity:.75;
      pointer-events:none;
    }

    .dragon3d{
      position:relative;
      width: min(360px, 70vw);
      aspect-ratio: 1/1;
      transform-style: preserve-3d;
      transform: rotateX(10deg) rotateY(-12deg);
      filter: drop-shadow(0 35px 60px rgba(0,0,0,.65));
      animation: dragonFloat 6.5s ease-in-out infinite;
      z-index:3;
    }
    @keyframes dragonFloat{
      0%,100%{transform: rotateX(10deg) rotateY(-12deg) translateY(0px) translateZ(0px)}
      50%{transform: rotateX(12deg) rotateY(-6deg) translateY(-8px) translateZ(10px)}
    }

    #dragonImg{
      width:100%;
      height:100%;
      object-fit:contain;
      transform: translateZ(22px);
      filter:
        drop-shadow(0 0 22px rgba(255,211,106,.18))
        drop-shadow(0 0 48px rgba(255,43,63,.08));
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }

    .dragonGlow{
      position:absolute;
      inset:-18%;
      border-radius:50%;
      background:
        radial-gradient(circle at 50% 50%, rgba(255,211,106,.22), transparent 55%),
        radial-gradient(circle at 50% 55%, rgba(255,43,63,.10), transparent 62%);
      transform: translateZ(0);
      filter: blur(1px);
      opacity:.9;
      pointer-events:none;
    }

    /* Orbits */
    .orbits{
      position:absolute;
      inset:0;
      transform-style: preserve-3d;
      pointer-events:none;
      z-index:2;
    }
    .orbit{
      position:absolute;
      left:50%; top:50%;
      width: var(--d);
      height: var(--d);
      margin-left: calc(var(--d)/-2);
      margin-top: calc(var(--d)/-2);
      border-radius:50%;
      border: 1px solid rgba(255,211,106,.10);
      transform:
        translateZ(var(--z))
        rotateX(var(--rx))
        rotateY(var(--ry));
      opacity:.85;
    }

    .planet{
      position:absolute;
      left:50%; top:50%;
      width: var(--p);
      height: var(--p);
      border-radius:50%;
      transform-style: preserve-3d;
      transform:
        rotate(var(--a))
        translateX(calc(var(--d)/2))
        translateZ(var(--pz));
      box-shadow:
        0 0 0 1px rgba(255,255,255,.10),
        0 18px 40px rgba(0,0,0,.45);
      background: radial-gradient(circle at 35% 30%, rgba(255,255,255,.35), rgba(255,255,255,0) 55%),
                  radial-gradient(circle at 60% 70%, rgba(0,0,0,.25), rgba(0,0,0,0) 55%),
                  linear-gradient(135deg, var(--c1), var(--c2));
      filter: saturate(1.05);
    }

    .planet:after{
      content: attr(data-name);
      position:absolute;
      left:50%;
      top: calc(100% + 10px);
      transform: translateX(-50%);
      font-size: 11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: rgba(255,255,255,.70);
      padding: 5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,211,106,.12);
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
      white-space:nowrap;
      pointer-events:none;
    }

    .spinWrap{
      position:absolute;
      inset:0;
      transform-style: preserve-3d;
      animation: orbitSpin var(--t) linear infinite;
    }
    @keyframes orbitSpin{
      from{transform: translateZ(0) rotateZ(0deg)}
      to{transform: translateZ(0) rotateZ(360deg)}
    }

    /* Content cards */
    .hero{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 980px){ .hero{grid-template-columns:1fr;} .brand{min-width:auto} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.035));
      border:1px solid rgba(255,211,106,.16);
      border-radius:26px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .card .inner{padding:16px}
    .card:before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(500px 200px at 30% 0%, rgba(255,211,106,.18), transparent 55%),
        radial-gradient(400px 280px at 85% 20%, rgba(255,43,63,.12), transparent 55%);
      pointer-events:none;
      opacity:.75;
    }
    .card .inner, .card .row, .card .grid{position:relative; z-index:2}

    .hline{
      display:flex; align-items:baseline; justify-content:space-between;
      gap:12px; flex-wrap:wrap; margin-bottom:10px;
    }
    .hline h2{
      margin:0;
      font-size:16px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color: rgba(255,211,106,.92);
    }

    .grid{display:grid;grid-template-columns: repeat(3, 1fr);gap:10px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .tile{
      border-radius:18px;
      padding:12px 12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
    }
    .tile .k{font-size:11px;color: rgba(255,255,255,.60);letter-spacing:.12em;text-transform:uppercase;}
    .tile .v{margin-top:6px;display:flex;align-items:baseline;gap:8px;flex-wrap:wrap;}
    .tile .v .big{font-size:22px;font-weight:1000;letter-spacing:.02em;color: rgba(255,211,106,.96);}
    .tile .v .tag{
      font-size:12px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,211,106,.22);
      background: rgba(255,211,106,.08);
      color: rgba(255,255,255,.85);
    }

    .stage{display:grid;grid-template-columns: 1fr;gap:10px;align-items:center;justify-items:center;}
    .wheelWrap{
      width:min(420px, 92vw);
      aspect-ratio: 1/1;
      position:relative;
      display:grid;
      place-items:center;
      margin: 6px auto 0;
    }
    canvas#wheel{
      width:100%;
      height:100%;
      border-radius:50%;
      box-shadow:
        0 0 0 1px rgba(255,211,106,.22),
        0 25px 70px rgba(0,0,0,.55),
        0 0 90px rgba(255,43,63,.08);
      background:
        radial-gradient(circle at 50% 45%, rgba(255,211,106,.14), transparent 45%),
        radial-gradient(circle at 50% 50%, rgba(0,0,0,.35), rgba(0,0,0,.75));
    }
    .centerMedal{
      position:absolute;
      width: 34%;
      aspect-ratio:1/1;
      border-radius:50%;
      background:
        radial-gradient(circle at 35% 28%, rgba(255,255,255,.30), transparent 45%),
        radial-gradient(circle at 50% 55%, rgba(255,211,106,.96), rgba(184,134,11,.86));
      box-shadow:
        0 0 0 1px rgba(255,211,106,.25),
        0 25px 70px rgba(255,211,106,.12);
      display:grid;
      place-items:center;
      pointer-events:none;
    }
    .centerMedal span{
      font-size: clamp(22px, 4vw, 34px);
      font-weight: 1000;
      color: #1a1406;
      text-shadow: 0 1px 0 rgba(255,255,255,.22);
    }
    .beam{
      position:absolute;
      right:-2%;
      top: 50%;
      transform: translateY(-50%);
      width: 46%;
      height: 18px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,211,106,0), rgba(255,211,106,.85), rgba(255,211,106,0));
      filter: blur(.2px);
      opacity:.95;
      pointer-events:none;
    }
    .beam:after{
      content:"";
      position:absolute;
      left: 46%;
      top:50%;
      transform: translate(-50%,-50%);
      width: 10px; height: 10px;
      border-radius: 50%;
      background: rgba(255,211,106,.95);
      box-shadow: 0 0 30px rgba(255,211,106,.65);
    }

    .wheelControls{
      width:min(560px, 94vw);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:8px;
    }

    .oracleBox{display:flex;flex-direction:column;gap:10px}
    .oracleText{
      border-radius:18px;
      padding:12px 12px;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      min-height: 98px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .oracleText .headline{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;flex-wrap:wrap;
    }
    .oracleText .headline b{
      color: rgba(255,211,106,.95);
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:12px;
    }
    .oracleText .body{font-size:14px;color:rgba(255,255,255,.85);line-height:1.35}
    .oracleText .meta{
      margin-top:auto;
      font-size:12px;
      color: rgba(255,255,255,.60);
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
    }
    .meta .chip{
      padding:6px 10px;border-radius:999px;
      background: rgba(255,211,106,.08);
      border:1px solid rgba(255,211,106,.20);
    }
    .meta .chip.red{background: rgba(255,43,63,.10);border-color: rgba(255,43,63,.26);}
    .meta .chip.ok{background: rgba(67,255,179,.10);border-color: rgba(67,255,179,.26);}

    .choices{display:flex;gap:10px;flex-wrap:wrap}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .tiny{font-size:12px; color: rgba(255,255,255,.60)}
    .hr{height:1px;background: rgba(255,255,255,.10);margin: 10px 0}

    /* Bottom Dock */
    .bottomDock{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:40;
      padding: 10px 12px 14px;
      background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.65));
      backdrop-filter: blur(12px);
      border-top: 1px solid rgba(255,211,106,.10);
    }
    .dockInner{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .dockBtn{
      flex:1;min-width:0;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:6px;
      padding:10px 6px;
      background: transparent;border:none;color:#fff;
      cursor:pointer;user-select:none;
    }
    .dockIcon{
      width: 54px;height: 54px;
      display:grid;place-items:center;
      border-radius: 18px;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.12), transparent 55%),
        linear-gradient(135deg, rgba(255,211,106,.16), rgba(255,43,63,.06));
      box-shadow:
        0 0 0 1px rgba(255,211,106,.14),
        0 16px 45px rgba(0,0,0,.35);
      transition: transform .25s ease;
    }
    .dockIcon span{font-size: 26px;filter: drop-shadow(0 10px 16px rgba(0,0,0,.45));}
    .dockBtn small{
      font-size: 11px;
      letter-spacing:.08em;
      color: rgba(255,255,255,.72);
      text-transform:uppercase;
      text-align:center;
    }
    .dockBtn:active .dockIcon{transform: translateY(1px) scale(.98)}
    .spinL{animation: spinL 1.05s cubic-bezier(.2,0,.2,1)}
    .spinR{animation: spinR 1.05s cubic-bezier(.2,0,.2,1)}
    @keyframes spinL{from{transform:rotate(0)}to{transform:rotate(-360deg)}}
    @keyframes spinR{from{transform:rotate(0)}to{transform:rotate(360deg)}}

    /* Modals */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.66);
      backdrop-filter: blur(10px);
      z-index:80;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px 12px;
    }
    .modal{
      width:min(720px, 96vw);
      border-radius: 26px;
      background: linear-gradient(180deg, rgba(20,20,22,.92), rgba(8,8,10,.92));
      border:1px solid rgba(255,211,106,.16);
      box-shadow: 0 28px 90px rgba(0,0,0,.70);
      overflow:hidden;
      position:relative;
    }
    .modal:before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(600px 260px at 30% 0%, rgba(255,211,106,.18), transparent 60%),
        radial-gradient(560px 340px at 95% 20%, rgba(255,43,63,.12), transparent 60%);
      opacity:.8;
      pointer-events:none;
    }
    .modal .mInner{position:relative; z-index:2; padding: 16px}
    .mHead{
      display:flex;align-items:flex-start;justify-content:space-between;
      gap:12px;margin-bottom:8px;
    }
    .mHead h3{
      margin:0;
      font-size:14px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: rgba(255,211,106,.92);
    }
    .mBody{
      color: rgba(255,255,255,.82);
      font-size:13px;
      line-height:1.45;
      max-height: 68vh;
      overflow:auto;
      padding-right: 6px;
    }
    .mBody .sec{margin:12px 0}
    .mBody .sec b{color: rgba(255,211,106,.95)}
    .mFoot{margin-top: 12px;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}

    body.luckyHour .sigil{
      box-shadow: 0 0 0 1px rgba(255,211,106,.32), 0 22px 60px rgba(255,211,106,.18);
    }
    body.luckyHour .beam{
      opacity:1;
      filter: blur(.1px);
      box-shadow: 0 0 40px rgba(255,211,106,.20);
    }

    /* ===== CH–Å–õ–ö–ê (FIXED): hidden by default; never huge on phone ===== */
    .bangToggle{
      width:40px;height:40px;          /* smaller on phone */
      border-radius:14px;
      border:1px solid rgba(255,211,106,.22);
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      color: rgba(255,211,106,.95);
      font-weight: 1000;
      font-size: 14px;
      cursor:pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      flex: 0 0 auto;
    }

    /* bang overlay sits UNDER topbar, so buttons stay clickable */
    #bang{
      position:fixed;
      left:0; right:0;
      top:0;
      height: min(42vh, 360px);
      z-index:50;               /* lower than topbar (90) */
      pointer-events:none;      /* DOES NOT catch clicks */
      transform: translateY(-110%);
      transition: transform .28s cubic-bezier(.2,0,.2,1);
      background:
        radial-gradient(900px 420px at 50% 30%, rgba(255,211,106,.22), transparent 60%),
        radial-gradient(900px 520px at 50% 70%, rgba(255,43,63,.12), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.92), rgba(0,0,0,0));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,211,106,.14);
    }
    #bang.open{
      transform: translateY(0);
      pointer-events:none; /* keep none always, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞–ª–æ –∫–ª–∏–∫–∏ */
    }

    @media (max-width: 420px){
      .bangToggle{width:38px;height:38px}
      #bang{height: min(36vh, 300px)}
      .pill{display:none} /* on tiny screens: remove time pill to avoid crowd */
    }
  </style>
</head>

<body>
  <canvas id="fxDust"></canvas>
  <canvas id="fxMeteors"></canvas>
  <div class="flash" id="flash"></div>

  <div id="webglRoot" aria-hidden="true">
    <canvas id="webgl"></canvas>
    <div id="webglVignette"></div>
  </div>

  <div id="bang" aria-hidden="true"></div>

  <div class="app">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="sigil"></div>
          <div class="brand-text">
            <div class="t1" id="tBrand1">TON TEMPLE</div>
            <div class="t2" id="tBrand2">Imperial Flow Ritual</div>
          </div>
        </div>

        <div class="top-controls">
          <!-- bang toggle -->
          <button class="bangToggle" id="btnBang" type="button" title="Bang">„Ä£</button>

          <!-- help (?) opens rules -->
          <button class="bangToggle" id="helpBtn" type="button" title="Rules / Guide">?</button>

          <div class="pill" title="Local time / Lucky Hour">
            <div class="small" id="tTimeLabel">LOCAL TIME</div>
            <b id="localTime">--:--</b>
            <span class="small" id="luckyCountdown">‚Ä¢ Next Lucky Hour --:--:--</span>
          </div>

          <div class="toggle">
            <span class="small" id="tModeLabel">MODE</span>
            <div class="seg" role="tablist" aria-label="Mode">
              <button id="btnRitual" class="active" type="button">RITUAL</button>
              <button id="btnPro" type="button">PRO</button>
            </div>
          </div>

          <div class="toggle">
            <span class="small" id="tLangLabel">LANG</span>
            <div class="seg" role="tablist" aria-label="Language">
              <button id="btnZH" type="button">‰∏≠Êñá</button>
              <button id="btnEN" type="button">EN</button>
              <button id="btnRU" class="active" type="button">RU</button>
            </div>
          </div>

          <!-- Rules button #1 -->
          <button class="btn secondary" id="btnRules" type="button">RULES</button>
        </div>
      </div>
    </div>

    <div class="wrap">

      <!-- NEW: DRAGON 3D + PLANETS -->
      <div class="dragonCard">
        <div class="dragonInner">
          <div class="dragonHead">
            <h2 id="tDragonTitle">Solar Dragon</h2>
            <div class="sub" id="tDragonSub">Centered 3D emblem + orbiting planets.</div>
          </div>

          <div class="dragonScene" aria-label="Dragon with planets">
            <div class="orbits" id="orbits"></div>

            <div class="dragon3d">
              <div class="dragonGlow"></div>
              <img id="dragonImg" src="dragon.jpg" alt="Dragon Emblem" />
            </div>
          </div>
        </div>
      </div>

      <!-- HERO -->
      <div class="hero">
        <!-- LEFT: HUD -->
        <div class="card">
          <div class="inner">
            <div class="hline">
              <h2 id="tHudTitle">Temple HUD</h2>
              <div class="sub" id="tHudSub">Everything is explained. First-time friendly.</div>
            </div>

            <div class="grid">
              <div class="tile">
                <div class="k" id="tQKLabel">QK ‚Äî Quantum Karma</div>
                <div class="v">
                  <div class="big" id="qk">37.11</div>
                  <div class="tag" id="qkTag">Balanced</div>
                </div>
                <div class="tiny" id="tQKHint">Your daily ritual energy. Used for status + progression.</div>
              </div>

              <div class="tile">
                <div class="k" id="tFlowScoreLabel">Flow Score</div>
                <div class="v">
                  <div class="big" id="flowScore">73</div>
                  <div class="tag" id="flowTag">Temple Guidance</div>
                </div>
                <div class="tiny" id="tFlowHint">0‚Äì100 indicator. Higher = calmer decisions.</div>
              </div>

              <div class="tile">
                <div class="k" id="tWeatherLabel">Market Weather</div>
                <div class="v">
                  <div class="big" id="weather">CALM</div>
                  <div class="tag" id="riskTag">Risk Aura: LOW</div>
                </div>
                <div class="tiny" id="tWeatherHint">A narrative layer that feels legit (not ‚Äúsignals‚Äù).</div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row">
              <div class="tiny" id="tDailySealLabel">Daily Seal</div>
              <div class="pill" style="padding:8px 10px">
                <b id="dailySeal">SEAL</b>
                <span class="small" id="sealSub">‚Ä¢ stamped</span>
              </div>
            </div>

            <div style="height:10px"></div>

            <div class="grid">
              <div class="tile">
                <div class="k" id="tStreakLabel">Streak</div>
                <div class="v">
                  <div class="big" id="streak">3</div>
                  <div class="tag" id="cycleTag">7/21/49 Path</div>
                </div>
                <div class="tiny" id="tStreakHint">Consistency unlocks status. Not ‚Äúpay to win‚Äù.</div>
              </div>

              <div class="tile">
                <div class="k" id="tStatsLabel">Today Stats</div>
                <div class="v">
                  <div class="big" id="posCount">8</div>
                  <div class="tag" id="negCountTag">Caution: 1</div>
                </div>
                <div class="tiny" id="tStatsHint">Hope engine: positives always dominate.</div>
              </div>

              <div class="tile">
                <div class="k" id="tSocialLabel">Temple Pulse</div>
                <div class="v">
                  <div class="big" id="socialA">3,482</div>
                  <div class="tag" id="socialB">VIP: 117</div>
                </div>
                <div class="tiny" id="tSocialHint">Social proof without chat (safe & clean).</div>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT: Wheel + Oracle -->
        <div class="card">
          <div class="inner">
            <div class="hline">
              <h2 id="tRitualTitle">Daily Ritual</h2>
              <div class="sub" id="tRitualSub">One spin per day. Slow. Visible. No blur.</div>
            </div>

            <div class="stage">
              <div class="wheelWrap" aria-label="Fortune wheel">
                <canvas id="wheel"></canvas>
                <div class="beam" aria-hidden="true"></div>
                <div class="centerMedal" aria-hidden="true"><span>Ë≤°</span></div>
              </div>

              <div class="wheelControls">
                <button class="btn" id="btnSpin" type="button">ACTIVATE FLOW</button>
                <button class="btn secondary" id="btnOracle" type="button">ORACLE</button>
                <button class="btn ghost" id="btnGate" type="button">OPEN GATE</button>
              </div>

              <div class="oracleBox" style="width:min(560px,94vw)">
                <div class="row">
                  <div class="toggle" style="flex:1; justify-content:space-between">
                    <span class="small" id="tForecastType">FORECAST</span>
                    <div class="seg">
                      <button id="btnForecastDay" class="active" type="button">DAY</button>
                      <button id="btnForecastTON" type="button">TON</button>
                    </div>
                  </div>
                  <div class="pill" style="flex:1; justify-content:space-between">
                    <span class="small" id="tLimitLabel">LIMIT</span>
                    <b id="limitText">1 / day</b>
                    <span class="small" id="limitPaywall">‚Ä¢ extra: 1 TON</span>
                  </div>
                </div>

                <div class="oracleText" id="oraclePanel">
                  <div class="headline">
                    <b id="oracleHead">Temple Guidance</b>
                    <span class="tiny" id="oracleStamp">‚Äî</span>
                  </div>
                  <div class="body" id="oracleBody">Tap ORACLE to receive guidance.</div>
                  <div class="meta" id="oracleMeta">
                    <span class="chip" id="chipWeather">Market Weather: Calm</span>
                    <span class="chip ok" id="chipAura">Risk Aura: Low</span>
                    <span class="chip" id="chipFlow">Flow Window: Open</span>
                  </div>
                </div>

                <div class="choices">
                  <button class="btn" id="btnEnter" type="button" disabled>ENTER</button>
                  <button class="btn secondary" id="btnWait" type="button" disabled>WAIT</button>
                  <button class="btn danger" id="btnSkip" type="button" disabled>SKIP</button>
                </div>

                <div class="tiny" id="tDisclaimer">This is a ritualized UI. Not financial advice.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PRO TERMINAL -->
      <div class="card" id="proCard">
        <div class="inner">
          <div class="hline">
            <h2 id="tProTitle">Pro Terminal</h2>
            <div class="sub" id="tProSub">Numbers for ‚Äúmianzi‚Äù: serious look, clean UI.</div>
          </div>

          <div class="grid">
            <div class="tile">
              <div class="k" id="tTonPulse">TON Pulse</div>
              <div class="v">
                <div class="big" id="tonPulse">+0.84%</div>
                <div class="tag" id="liqPulse">Liquidity: Steady</div>
              </div>
              <div class="tiny" id="tTonPulseHint">Synthetic metrics for premium terminal feel (MVP).</div>
            </div>

            <div class="tile">
              <div class="k" id="tVol">Volatility</div>
              <div class="v">
                <div class="big" id="vol">12.4</div>
                <div class="tag" id="trend">Trend: Up</div>
              </div>
              <div class="tiny" id="tVolHint">Used to shape Risk Aura + Gate warning.</div>
            </div>

            <div class="tile">
              <div class="k" id="tWindow">Flow Window</div>
              <div class="v">
                <div class="big" id="flowWindow">OPEN</div>
                <div class="tag" id="windowTimer">Next: 02:14:18</div>
              </div>
              <div class="tiny" id="tWindowHint">Aligned with Lucky Hour schedule.</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="hline">
            <h2 id="tJournalTitle">Temple Journal</h2>
            <div class="sub" id="tJournalSub">Last 7 days (decision memory).</div>
          </div>

          <div class="tile">
            <div class="tiny" id="journal"></div>
          </div>
        </div>
      </div>

      <!-- EXTRA -->
      <div class="card">
        <div class="inner">
          <div class="hline">
            <h2 id="tExtraTitle">Temple Layer</h2>
            <div class="sub" id="tExtraSub">Scrollable content (not one-screen only).</div>
          </div>
          <div class="tile">
            <div class="tiny" id="tExtraBody">
              This area is intentionally long to allow natural scrolling.
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Bottom Dock -->
    <div class="bottomDock" role="navigation" aria-label="Temple Dock">
      <div class="dockInner">
        <button class="dockBtn" id="dockRitual" type="button">
          <div class="dockIcon"><span>üúÅ</span></div>
          <small id="dRitual">Ritual</small>
        </button>
        <button class="dockBtn" id="dockWheel" type="button">
          <div class="dockIcon"><span>üé°</span></div>
          <small id="dWheel">Wheel</small>
        </button>
        <button class="dockBtn" id="dockOracle" type="button">
          <div class="dockIcon"><span>üßø</span></div>
          <small id="dOracle">Oracle</small>
        </button>
        <button class="dockBtn" id="dockGate" type="button">
          <div class="dockIcon"><span>‚ü†</span></div>
          <small id="dGate">Gate</small>
        </button>
        <!-- Rules button #2 -->
        <button class="dockBtn" id="dockRules" type="button">
          <div class="dockIcon"><span>‚ùñ</span></div>
          <small id="dRules">Rules</small>
        </button>
      </div>
    </div>
  </div>

  <!-- RULES MODAL -->
  <div class="modalBack" id="rulesBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mInner">
        <div class="mHead">
          <h3 id="rulesTitle">Rules / What is this?</h3>
          <button class="btn ghost" id="rulesClose" type="button">Close</button>
        </div>
        <div class="mBody" id="rulesBody"></div>
        <div class="mFoot">
          <button class="btn secondary" id="rulesOk" type="button">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PAYWALL MODAL -->
  <div class="modalBack" id="payBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mInner">
        <div class="mHead">
          <h3 id="payTitle">Golden Altar</h3>
          <button class="btn ghost" id="payClose" type="button">Close</button>
        </div>
        <div class="mBody" id="payBody"></div>
        <div class="mFoot">
          <button class="btn secondary" id="payLater" type="button">Later</button>
          <button class="btn" id="payMock" type="button">Donate 1 TON (Mock)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RISK GATE MODAL -->
  <div class="modalBack" id="riskBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mInner">
        <div class="mHead">
          <h3 id="riskTitle">Risk Gate</h3>
          <button class="btn ghost" id="riskClose" type="button">Close</button>
        </div>
        <div class="mBody" id="riskBody"></div>
        <div class="mFoot">
          <button class="btn secondary" id="riskCancel" type="button">Cancel</button>
          <button class="btn" id="riskGo" type="button">Enter Gate</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  /*****************************************************************
   * TON TEMPLE ‚Äî Dragon Center + Planets + Fixed Bang + Full i18n
   *****************************************************************/

  const $ = (id) => document.getElementById(id);
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const rnd = (a=0, b=1) => a + Math.random()*(b-a);
  const irnd = (a,b) => Math.floor(rnd(a,b+1));
  const pad2 = (n) => String(n).padStart(2,'0');
  const dayKey = (d=new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const nowHM = (d=new Date()) => `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  const nowHMS = (d=new Date()) => `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;

  function flash(){
    const f = $('flash');
    f.classList.add('on');
    setTimeout(()=>f.classList.remove('on'), 140);
  }

  const state = {
    lang: 'ru',
    mode: 'ritual',
    qk: 37.11,
    flowScore: 73,
    weather: 'CALM',
    risk: 'LOW',
    streak: 3,
    today: { key: dayKey(), oracleUsed: false, oraclePaidExtra: 0, pos: 8, neg: 1 },
    oracle: { type:'day', last:null, decision:null },
    wheel: { petals: 15, angle: 0, spinning: false, usedToday: false, velocity: 0, friction: 0.987, stopEps: 0.0010, resultIndex: null },
    gate: { refUrl: "https://example.com" },
    lucky: { morningHour:9, eveningHour:21, windowMinutes:45, isLuckyNow:false, nextLuckyIn:0 },
    social: {a:3482, vip:117},
    journal: []
  };

  const LS_KEY = 'ton_temple_dragon_v1';
  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      const saved = JSON.parse(raw);
      const k = dayKey();

      if(saved?.today?.key !== k){
        state.today.key = k;
        state.today.oracleUsed = false;
        state.today.oraclePaidExtra = 0;
        state.today.pos = irnd(6,12);
        state.today.neg = irnd(0,2);
        state.wheel.usedToday = false;
        state.oracle.last = null;
        state.oracle.decision = null;
        state.streak = (saved?.streak && saved?.today?.key) ? (saved.streak + 1) : 1;
      } else {
        Object.assign(state, saved);
      }
      state.qk = clamp(Number(state.qk)||37.11, 0, 9999);
      state.flowScore = clamp(Number(state.flowScore)||73, 0, 100);
      if(!Array.isArray(state.journal)) state.journal = [];
      state.journal = state.journal.slice(0,7);
    }catch(e){}
  }
  function saveState(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){} }

  /* ===== FULL i18n: RU / EN / ZH ===== */
  const I18N = {
    ru: {
      brand1:"TON TEMPLE",
      brand2:"–ò–º–ø–µ—Ä—Å–∫–∏–π —Ä–∏—Ç—É–∞–ª –∫–≤–∞–Ω—Ç–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞",
      timeLabel:"–ú–ï–°–¢–ù–û–ï –í–†–ï–ú–Ø",
      modeLabel:"–†–ï–ñ–ò–ú",
      langLabel:"–Ø–ó–´–ö",
      rules:"–ü–†–ê–í–ò–õ–ê",

      dragonTitle:"Solar Dragon",
      dragonSub:"–≠–º–±–ª–µ–º–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É (3D) + –ø–ª–∞–Ω–µ—Ç—ã –ø–æ –æ—Ä–±–∏—Ç–∞–º.",

      hudTitle:"HUD –•–†–ê–ú–ê",
      hudSub:"–í—Å—ë –æ–±—ä—è—Å–Ω–µ–Ω–æ. –ü–æ–¥—Ö–æ–¥–∏—Ç —Å –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.",
      qkLabel:"QK ‚Äî –ö–≤–∞–Ω—Ç–æ–≤–∞—è –∫–∞—Ä–º–∞",
      qkHint:"–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è —Ä–∏—Ç—É–∞–ª–∞: —Å—Ç–∞—Ç—É—Å, –ø—Ä–æ–≥—Ä–µ—Å—Å, —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.",
      flowScoreLabel:"FLOW SCORE",
      flowHint:"–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä 0‚Äì100. –ß–µ–º –≤—ã—à–µ ‚Äî —Ç–µ–º —Å–ø–æ–∫–æ–π–Ω–µ–µ —Ä–µ—à–µ–Ω–∏—è.",
      weatherLabel:"–ü–û–ì–û–î–ê –†–´–ù–ö–ê",
      weatherHint:"–ù–∞—Ä—Ä–∞—Ç–∏–≤ ‚Äú–∫–∞–∫ —Ç–µ—Ä–º–∏–Ω–∞–ª‚Äù, –∞ –Ω–µ ‚Äú—Å–∏–≥–Ω–∞–ª—ã‚Äù.",
      dailySeal:"–ü–ï–ß–ê–¢–¨ –î–ù–Ø",
      sealStamped:"‚Ä¢ –ø—Ä–æ—Å—Ç–∞–≤–ª–µ–Ω–æ",
      streak:"–°–ï–†–ò–Ø",
      streakHint:"–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —á–µ—Ä–µ–∑ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å, –Ω–µ —Ç–æ–ª—å–∫–æ –¥–æ–Ω–∞—Ç.",
      stats:"–°–¢–ê–¢–ò–°–¢–ò–ö–ê –î–ù–Ø",
      statsHint:"–î–∏–∑–∞–π–Ω-–ø—Ä–∞–≤–∏–ª–æ: –ø–æ–∑–∏—Ç–∏–≤ –≤—Å–µ–≥–¥–∞ –¥–æ–º–∏–Ω–∏—Ä—É–µ—Ç.",
      caution:"–û—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å",
      social:"–ü–£–õ–¨–° –•–†–ê–ú–ê",
      socialHint:"–°–æ—Ü.–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –±–µ–∑ —á–∞—Ç–∞ (—á–∏—Å—Ç–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ).",

      ritualTitle:"–ï–ñ–ï–î–ù–ï–í–ù–´–ô –†–ò–¢–£–ê–õ",
      ritualSub:"–û–¥–∏–Ω –º–µ–¥–ª–µ–Ω–Ω—ã–π —Å–ø–∏–Ω –≤ –¥–µ–Ω—å. –ë–µ–∑ –±–ª—é—Ä–∞.",
      activateFlow:"–ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨ –ü–û–¢–û–ö",
      oracle:"–û–†–ê–ö–£–õ",
      gate:"–û–¢–ö–†–´–¢–¨ –í–†–ê–¢–ê",
      forecast:"–ü–†–û–ì–ù–û–ó",
      day:"DAY",
      ton:"TON",
      limit:"–õ–ò–ú–ò–¢",
      limitExtra:"‚Ä¢ –¥–æ–ø: 1 TON",
      oracleHead:"–£–∫–∞–∑ —Ö—Ä–∞–º–∞",
      oracleTap:"–ù–∞–∂–º–∏ ORACLE, –ø–æ–ª—É—á–∏ —É–∫–∞–∑. –ü–æ—Ç–æ–º –≤—ã–±–µ—Ä–∏: ENTER / WAIT / SKIP.",
      enter:"ENTER",
      wait:"WAIT",
      skip:"SKIP",
      disclaimer:"–≠—Ç–æ —Ä–∏—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π UI. –ù–µ —Ñ–∏–Ω—Å–æ–≤–µ—Ç. –†–µ—à–µ–Ω–∏–µ –∑–∞ —Ç–æ–±–æ–π.",

      proTitle:"PRO-–¢–ï–†–ú–ò–ù–ê–õ",
      proSub:"–¶–∏—Ñ—Ä—ã ‚Äú–¥–ª—è —Å—Ç–∞—Ç—É—Å–∞‚Äù: —Å–µ—Ä—å—ë–∑–Ω–æ, —á–∏—Å—Ç–æ, –∫–∞–∫ —Ç–µ—Ä–º–∏–Ω–∞–ª.",
      tonPulse:"TON Pulse",
      tonPulseHint:"–°–∏–Ω—Ç–µ—Ç–∏–∫–∞ –¥–ª—è –ø—Ä–µ–º–∏—É–º-—Ç–µ—Ä–º–∏–Ω–∞–ª–∞ (MVP).",
      vol:"–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å",
      volHint:"–í–ª–∏—è–µ—Ç –Ω–∞ Risk Aura –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ Gate.",
      window:"–û–∫–Ω–æ –ø–æ—Ç–æ–∫–∞",
      windowHint:"–°–∏–Ω—Ö—Ä–æ–Ω —Å Lucky Hour —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º.",

      journalTitle:"–ñ–£–†–ù–ê–õ –•–†–ê–ú–ê",
      journalSub:"–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π (–ø–∞–º—è—Ç—å —Ä–µ—à–µ–Ω–∏–π).",
      noRecords:"–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.",

      extraTitle:"–°–õ–û–ô –•–†–ê–ú–ê",
      extraSub:"–°–∫—Ä–æ–ª–ª (–Ω–µ –æ–¥–∏–Ω —ç–∫—Ä–∞–Ω).",
      extraBody:"–ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ: —Ç—Ä–æ—Ñ–µ–∏ 7/21/49, —Å–∫–∏–Ω—ã, VIP –∑–∞–ª, –±—É–¥—É—â–∏–π TON Connect.",

      dockRitual:"–†–∏—Ç—É–∞–ª",
      dockWheel:"–ö–æ–ª–µ—Å–æ",
      dockOracle:"–û—Ä–∞–∫—É–ª",
      dockGate:"–í—Ä–∞—Ç–∞",
      dockRules:"–ü—Ä–∞–≤–∏–ª–∞",

      rulesTitle:"–ü—Ä–∞–≤–∏–ª–∞ / –ì–∞–π–¥ –ø–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º",
      close:"–ó–∞–∫—Ä—ã—Ç—å",
      ok:"–û–ö",

      payTitle:"–ó–æ–ª–æ—Ç–æ–π –∞–ª—Ç–∞—Ä—å",
      payLater:"–ü–æ–∑–∂–µ",
      payNow:"–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å 1 TON (Mock)",
      payText1:"–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ª–∏–º–∏—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏—Å—á–µ—Ä–ø–∞–Ω.",
      payText2:"‚Äú–ó–æ–ª–æ—Ç–æ–π –∞–ª—Ç–∞—Ä—å‚Äù –¥–∞—ë—Ç –µ—â—ë 1 —É–∫–∞–∑ –∑–∞ 1 TON (–ø–æ–∫–∞ Mock).",

      riskTitle:"–í—Ä–∞—Ç–∞ —Ä–∏—Å–∫–∞",
      riskText1:"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å: —Ä–∏—Å–∫-–∞—É—Ä–∞ –∏ –ª–∏—á–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å.",
      riskText2:"–û—Ç–∫—Ä–æ–µ—Ç—Å—è –≤–Ω–µ—à–Ω—è—è —Å—Å—ã–ª–∫–∞ (—Ç–≤–æ–π ref).",
      riskAgree:"–Ø –ø–æ–Ω–∏–º–∞—é —Ä–∏—Å–∫",
      cancel:"–û—Ç–º–µ–Ω–∞",
      go:"–í–æ–π—Ç–∏"
    },

    en: {
      brand1:"TON TEMPLE",
      brand2:"Imperial Quantum Flow Ritual",
      timeLabel:"LOCAL TIME",
      modeLabel:"MODE",
      langLabel:"LANG",
      rules:"RULES",

      dragonTitle:"Solar Dragon",
      dragonSub:"Centered 3D emblem + orbiting planets.",

      hudTitle:"Temple HUD",
      hudSub:"First-time friendly: everything is explained.",
      qkLabel:"QK ‚Äî Quantum Karma",
      qkHint:"Daily ritual energy for status, progression, unlocks.",
      flowScoreLabel:"FLOW SCORE",
      flowHint:"0‚Äì100 indicator. Higher = calmer decisions.",
      weatherLabel:"MARKET WEATHER",
      weatherHint:"Terminal-like narrative (not ‚Äúsignals‚Äù).",
      dailySeal:"DAILY SEAL",
      sealStamped:"‚Ä¢ stamped",
      streak:"STREAK",
      streakHint:"Unlock via consistency (not pure spending).",
      stats:"TODAY STATS",
      statsHint:"Hope engine: positives dominate by design.",
      caution:"Caution",
      social:"TEMPLE PULSE",
      socialHint:"Social proof without chat (safe & clean).",

      ritualTitle:"DAILY RITUAL",
      ritualSub:"One slow spin per day. No blur.",
      activateFlow:"ACTIVATE FLOW",
      oracle:"ORACLE",
      gate:"OPEN GATE",
      forecast:"FORECAST",
      day:"DAY",
      ton:"TON",
      limit:"LIMIT",
      limitExtra:"‚Ä¢ extra: 1 TON",
      oracleHead:"Temple Guidance",
      oracleTap:"Tap ORACLE to receive guidance, then choose: ENTER / WAIT / SKIP.",
      enter:"ENTER",
      wait:"WAIT",
      skip:"SKIP",
      disclaimer:"Ritualized UI. Not financial advice. Use your judgment.",

      proTitle:"PRO TERMINAL",
      proSub:"Numbers for ‚Äúmianzi‚Äù: serious, clean UI.",
      tonPulse:"TON Pulse",
      tonPulseHint:"Synthetic metrics for premium terminal feel (MVP).",
      vol:"Volatility",
      volHint:"Shapes Risk Aura + Gate warning.",
      window:"Flow Window",
      windowHint:"Aligned with Lucky Hour schedule.",

      journalTitle:"TEMPLE JOURNAL",
      journalSub:"Last 7 days (decision memory).",
      noRecords:"No records yet.",

      extraTitle:"TEMPLE LAYER",
      extraSub:"Scrollable (not a single screen).",
      extraBody:"Reserved for: Trophy Room 7/21/49, skins, VIP Hall, future TON Connect.",

      dockRitual:"Ritual",
      dockWheel:"Wheel",
      dockOracle:"Oracle",
      dockGate:"Gate",
      dockRules:"Rules",

      rulesTitle:"Rules / Indicator Guide",
      close:"Close",
      ok:"OK",

      payTitle:"Golden Altar",
      payLater:"Later",
      payNow:"Donate 1 TON (Mock)",
      payText1:"Free daily limit reached.",
      payText2:"‚ÄúGolden Altar‚Äù grants 1 more oracle for 1 TON (Mock).",

      riskTitle:"Risk Gate",
      riskText1:"Confirm: Risk Aura & your own judgment.",
      riskText2:"This will open an external link (your ref).",
      riskAgree:"I understand the risk",
      cancel:"Cancel",
      go:"Enter"
    },

    zh: {
      brand1:"TON TEMPLE",
      brand2:"Â∏ùÁéãÈáèÂ≠êÁ¶èÊµÅ‰ª™Âºè",
      timeLabel:"Êú¨Âú∞Êó∂Èó¥",
      modeLabel:"Ê®°Âºè",
      langLabel:"ËØ≠Ë®Ä",
      rules:"ËßÑÂàô",

      dragonTitle:"Solar Dragon",
      dragonSub:"‰∏≠ÂøÉ 3D ÂæΩÁ´† + Ë°åÊòüÁéØÁªïËΩ®ÈÅì„ÄÇ",

      hudTitle:"Á•ûÊÆø HUD",
      hudSub:"Êñ∞ÊâãÂèãÂ•ΩÔºöÊâÄÊúâÊåáÊ†áÈÉΩËß£ÈáäÊ∏ÖÊ•ö„ÄÇ",
      qkLabel:"QK ‚Äî ÈáèÂ≠êÁ¶è‰∏öÂÄº",
      qkHint:"ÊØèÊó•‰ª™ÂºèËÉΩÈáèÔºöÁî®‰∫éÁä∂ÊÄÅ„ÄÅËøõÂ∫¶‰∏éËß£ÈîÅ„ÄÇ",
      flowScoreLabel:"FLOW SCORE",
      flowHint:"0‚Äì100 ÊåáÊ†á„ÄÇË∂äÈ´òË∂äÂÜ∑Èùô„ÄÇ",
      weatherLabel:"Â∏ÇÂú∫Â§©Ê∞î",
      weatherHint:"Áî®‚ÄúÂêàÊ≥ïËØçÊ±á‚ÄùË°®ËææÔºåËÄå‰∏çÊòØ‚Äú‰ø°Âè∑‚Äù„ÄÇ",
      dailySeal:"‰ªäÊó•Âç∞Á´†",
      sealStamped:"‚Ä¢ Â∑≤ÁõñÁ´†",
      streak:"ËøûÂáª",
      streakHint:"Èù†ÂùöÊåÅËß£ÈîÅÔºå‰∏çÊòØÁ∫ØÊ∞™Èáë„ÄÇ",
      stats:"‰ªäÊó•ÁªüËÆ°",
      statsHint:"Â∏åÊúõÂºïÊìéÔºöÊ≠£ÂêëÊ∞∏ËøúÊõ¥Â§ö„ÄÇ",
      caution:"Ë∞®ÊÖé",
      social:"Á•ûÊÆøËÑâÂÜ≤",
      socialHint:"Êó†ËÅäÂ§©ÁöÑÁ§æ‰∫§ËØÅÊòéÔºàÂÆâÂÖ®„ÄÅÂπ≤ÂáÄÔºâ„ÄÇ",

      ritualTitle:"ÊØèÊó•‰ª™Âºè",
      ritualSub:"ÊØèÂ§©‰∏ÄÊ¨°ÊÖ¢ÈÄüËΩ¨Áõò„ÄÇÊó†Ê®°Á≥ä„ÄÇ",
      activateFlow:"ÂêØÂä®Á¶èÊµÅ",
      oracle:"Á•ûË∞ï",
      gate:"ÂºÄÂêØ‰πãÈó®",
      forecast:"È¢ÑÊµã",
      day:"DAY",
      ton:"TON",
      limit:"ÈôêÂà∂",
      limitExtra:"‚Ä¢ È¢ùÂ§ñ: 1 TON",
      oracleHead:"Á•ûÊÆøÊåáÂºï",
      oracleTap:"ÁÇπÂáª ORACLE Ëé∑ÂèñÊåáÂºïÔºåÁÑ∂ÂêéÈÄâÊã©ÔºöENTER / WAIT / SKIP„ÄÇ",
      enter:"ENTER",
      wait:"WAIT",
      skip:"SKIP",
      disclaimer:"ËøôÊòØ‰ª™ÂºèÂåñ UI„ÄÇÈùûÊäïËµÑÂª∫ËÆÆ„ÄÇËØ∑Ëá™Ë°åÂà§Êñ≠„ÄÇ",

      proTitle:"‰∏ì‰∏öÁªàÁ´Ø",
      proSub:"ÁªôÈù¢Â≠êÔºö‰∏•ËÇÉ„ÄÅÂπ≤ÂáÄ„ÄÅÂÉèÁªàÁ´Ø„ÄÇ",
      tonPulse:"TON Pulse",
      tonPulseHint:"ÂêàÊàêÊåáÊ†áÁî®‰∫éÁªàÁ´ØÊÑüÔºàMVPÔºâ„ÄÇ",
      vol:"Ê≥¢Âä®Áéá",
      volHint:"ÂΩ±Âìç Risk Aura ‰∏é Gate ÊèêÁ§∫„ÄÇ",
      window:"Á¶èÊµÅÁ™óÂè£",
      windowHint:"‰∏é Lucky Hour ÂØπÈΩê„ÄÇ",

      journalTitle:"Á•ûÊÆøÊó•Âøó",
      journalSub:"ÊúÄËøë 7 Â§©ÔºàÂÜ≥Á≠ñËÆ∞ÂøÜÔºâ„ÄÇ",
      noRecords:"ÊöÇÊó†ËÆ∞ÂΩï„ÄÇ",

      extraTitle:"Á•ûÊÆøÂ±Ç",
      extraSub:"ÂèØÊªöÂä®Ôºà‰∏çÊ≠¢‰∏ÄÂ±èÔºâ„ÄÇ",
      extraBody:"È¢ÑÁïôÔºöÂ•ñÊùØÂÆ§ 7/21/49„ÄÅÁöÆËÇ§„ÄÅVIP Â§ßÂéÖ„ÄÅÊú™Êù• TON Connect„ÄÇ",

      dockRitual:"‰ª™Âºè",
      dockWheel:"ËΩ¨Áõò",
      dockOracle:"Á•ûË∞ï",
      dockGate:"‰πãÈó®",
      dockRules:"ËßÑÂàô",

      rulesTitle:"ËßÑÂàô / ÊåáÊ†áËØ¥Êòé",
      close:"ÂÖ≥Èó≠",
      ok:"Â•ΩÁöÑ",

      payTitle:"ÈªÑÈáëÁ•≠Âùõ",
      payLater:"Á®çÂêé",
      payNow:"‰æõÂ•â 1 TONÔºàMockÔºâ",
      payText1:"‰ªäÊó•ÂÖçË¥πÊ¨°Êï∞Â∑≤Áî®ÂÆå„ÄÇ",
      payText2:"‚ÄúÈªÑÈáëÁ•≠Âùõ‚Äù‰ª• 1 TON Ëé∑ÂæóÈ¢ùÂ§ñ‰∏ÄÊ¨°ÔºàÂΩìÂâç MockÔºâ„ÄÇ",

      riskTitle:"È£éÈô©‰πãÈó®",
      riskText1:"ËøõÂÖ•ÂâçÁ°ÆËÆ§ÔºöÈ£éÈô©ÂÖâÁéØ‰∏éËá™ÊàëÂà§Êñ≠„ÄÇ",
      riskText2:"Â∞ÜÊâìÂºÄÂ§ñÈÉ®ÈìæÊé•Ôºà‰Ω†ÁöÑ refÔºâ„ÄÇ",
      riskAgree:"ÊàëÂ∑≤ÁêÜËß£È£éÈô©",
      cancel:"ÂèñÊ∂à",
      go:"ËøõÂÖ•"
    }
  };

  const t = (key) => (I18N[state.lang] && I18N[state.lang][key]) || (I18N.en[key] || key);

  function applyI18n(){
    document.documentElement.lang = state.lang;

    $('tBrand1').textContent = t('brand1');
    $('tBrand2').textContent = t('brand2');
    $('tTimeLabel').textContent = t('timeLabel');
    $('tModeLabel').textContent = t('modeLabel');
    $('tLangLabel').textContent = t('langLabel');
    $('btnRules').textContent = t('rules');

    $('tDragonTitle').textContent = t('dragonTitle');
    $('tDragonSub').textContent = t('dragonSub');

    $('tHudTitle').textContent = t('hudTitle');
    $('tHudSub').textContent = t('hudSub');
    $('tQKLabel').textContent = t('qkLabel');
    $('tQKHint').textContent = t('qkHint');
    $('tFlowScoreLabel').textContent = t('flowScoreLabel');
    $('tFlowHint').textContent = t('flowHint');
    $('tWeatherLabel').textContent = t('weatherLabel');
    $('tWeatherHint').textContent = t('weatherHint');

    $('tDailySealLabel').textContent = t('dailySeal');
    $('sealSub').textContent = t('sealStamped');

    $('tStreakLabel').textContent = t('streak');
    $('tStreakHint').textContent = t('streakHint');
    $('tStatsLabel').textContent = t('stats');
    $('tStatsHint').textContent = t('statsHint');
    $('tSocialLabel').textContent = t('social');
    $('tSocialHint').textContent = t('socialHint');

    $('tRitualTitle').textContent = t('ritualTitle');
    $('tRitualSub').textContent = t('ritualSub');
    $('btnSpin').textContent = t('activateFlow');
    $('btnOracle').textContent = t('oracle');
    $('btnGate').textContent = t('gate');
    $('tForecastType').textContent = t('forecast');
    $('btnForecastDay').textContent = t('day');
    $('btnForecastTON').textContent = t('ton');
    $('tLimitLabel').textContent = t('limit');
    $('limitPaywall').textContent = t('limitExtra');
    $('oracleHead').textContent = t('oracleHead');
    if(!state.oracle.last) $('oracleBody').textContent = t('oracleTap');
    $('btnEnter').textContent = t('enter');
    $('btnWait').textContent = t('wait');
    $('btnSkip').textContent = t('skip');
    $('tDisclaimer').textContent = t('disclaimer');

    $('tProTitle').textContent = t('proTitle');
    $('tProSub').textContent = t('proSub');
    $('tTonPulse').textContent = t('tonPulse');
    $('tTonPulseHint').textContent = t('tonPulseHint');
    $('tVol').textContent = t('vol');
    $('tVolHint').textContent = t('volHint');
    $('tWindow').textContent = t('window');
    $('tWindowHint').textContent = t('windowHint');

    $('tJournalTitle').textContent = t('journalTitle');
    $('tJournalSub').textContent = t('journalSub');

    $('tExtraTitle').textContent = t('extraTitle');
    $('tExtraSub').textContent = t('extraSub');
    $('tExtraBody').textContent = t('extraBody');

    $('dRitual').textContent = t('dockRitual');
    $('dWheel').textContent = t('dockWheel');
    $('dOracle').textContent = t('dockOracle');
    $('dGate').textContent = t('dockGate');
    $('dRules').textContent = t('dockRules');

    $('rulesTitle').textContent = t('rulesTitle');
    $('rulesClose').textContent = t('close');
    $('rulesOk').textContent = t('ok');

    $('payTitle').textContent = t('payTitle');
    $('payClose').textContent = t('close');
    $('payLater').textContent = t('payLater');
    $('payMock').textContent = t('payNow');

    $('riskTitle').textContent = t('riskTitle');
    $('riskClose').textContent = t('close');
    $('riskCancel').textContent = t('cancel');
    $('riskGo').textContent = t('go');

    $('btnZH').classList.toggle('active', state.lang==='zh');
    $('btnEN').classList.toggle('active', state.lang==='en');
    $('btnRU').classList.toggle('active', state.lang==='ru');
  }

  /* ===== Dragon Planets (names per language) ===== */
  const PLANETS = {
    ru: ["–ú–µ—Ä–∫—É—Ä–∏–π","–í–µ–Ω–µ—Ä–∞","–ó–µ–º–ª—è","–ú–∞—Ä—Å","–Æ–ø–∏—Ç–µ—Ä","–°–∞—Ç—É—Ä–Ω","–£—Ä–∞–Ω","–ù–µ–ø—Ç—É–Ω"],
    en: ["Mercury","Venus","Earth","Mars","Jupiter","Saturn","Uranus","Neptune"],
    zh: ["Ê∞¥Êòü","ÈáëÊòü","Âú∞ÁêÉ","ÁÅ´Êòü","Êú®Êòü","ÂúüÊòü","Â§©ÁéãÊòü","Êµ∑ÁéãÊòü"]
  };

  function buildOrbits(){
    const root = $('orbits');
    root.innerHTML = "";

    const names = PLANETS[state.lang] || PLANETS.en;

    const cfg = [
      {d: 260, p: 14, t: 9.0,  z: -20, rx:"62deg", ry:"10deg", pz:  8,  a:"20deg",  c1:"#c2b280", c2:"#7a6a4a"},
      {d: 320, p: 18, t: 12.0, z: -10, rx:"58deg", ry:"-8deg",pz: 10, a:"120deg", c1:"#f4caa6", c2:"#b77e53"},
      {d: 390, p: 20, t: 15.5, z:  0,  rx:"54deg", ry:"14deg",pz: 12, a:"220deg", c1:"#3fa9f5", c2:"#1b3b8f"},
      {d: 460, p: 16, t: 18.0, z:  8,  rx:"50deg", ry:"-10deg",pz: 14,a:"310deg", c1:"#ff7a4b", c2:"#8f1b10"},
      {d: 560, p: 28, t: 24.0, z: 16,  rx:"46deg", ry:"8deg", pz: 18, a:"70deg",  c1:"#f1d07a", c2:"#b07c2b"},
      {d: 650, p: 26, t: 30.0, z: 22,  rx:"44deg", ry:"-12deg",pz: 20,a:"170deg", c1:"#ffe8a8", c2:"#a7792b"},
      {d: 740, p: 22, t: 36.0, z: 28,  rx:"42deg", ry:"10deg",pz: 22,a:"250deg", c1:"#88d7ff", c2:"#2a7a9b"},
      {d: 840, p: 22, t: 44.0, z: 34,  rx:"40deg", ry:"-6deg", pz: 24,a:"340deg", c1:"#6fa8ff", c2:"#2b3f9f"},
    ];

    cfg.forEach((c, i)=>{
      const orbit = document.createElement("div");
      orbit.className = "orbit";
      orbit.style.setProperty("--d", c.d+"px");
      orbit.style.setProperty("--z", c.z+"px");
      orbit.style.setProperty("--rx", c.rx);
      orbit.style.setProperty("--ry", c.ry);

      const spin = document.createElement("div");
      spin.className = "spinWrap";
      spin.style.setProperty("--t", c.t+"s");

      const planet = document.createElement("div");
      planet.className = "planet";
      planet.style.setProperty("--d", c.d+"px");
      planet.style.setProperty("--p", c.p+"px");
      planet.style.setProperty("--pz", c.pz+"px");
      planet.style.setProperty("--a", c.a);
      planet.style.setProperty("--c1", c.c1);
      planet.style.setProperty("--c2", c.c2);
      planet.setAttribute("data-name", names[i]);

      spin.appendChild(planet);
      orbit.appendChild(spin);
      root.appendChild(orbit);
    });
  }

  /* ===== Bang toggle ===== */
  function toggleBang(){ $('bang').classList.toggle('open'); }

  /* ===== Rules content (localized) ===== */
  function rulesHTML(){
    if(state.lang==='ru'){
      return `
        <div class="sec"><b>–û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞:</b> –≠—Ç–æ ‚Äú—Ä–∏—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π UI‚Äù. –ú—ã –ø—Ä–æ–¥–∞—ë–º —Ä–∏—Ç–º/—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å/—Å—Ç–∞—Ç—É—Å, –∞ –Ω–µ ‚Äú—Å–∏–≥–Ω–∞–ª—ã‚Äù.</div>
        <div class="sec"><b>QK</b> ‚Äî —ç–Ω–µ—Ä–≥–∏—è —Å—Ç–∞—Ç—É—Å–∞. –î–∞—ë—Ç—Å—è –∫–æ–ª–µ—Å–æ–º/–æ—Ä–∞–∫—É–ª–æ–º/—Ä–µ—à–µ–Ω–∏–µ–º.</div>
        <div class="sec"><b>Flow Score (0‚Äì100)</b> ‚Äî –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏—è —Ä–µ—à–µ–Ω–∏–π.</div>
        <div class="sec"><b>–ü–æ–≥–æ–¥–∞ —Ä—ã–Ω–∫–∞</b> ‚Äî –Ω–∞—Ä—Ä–∞—Ç–∏–≤: CALM / BREEZE / HEAVY / STORM.</div>
        <div class="sec"><b>Risk Aura</b> ‚Äî LOW / MED / HIGH. –ü–µ—Ä–µ–¥ Gate –≤—Å–µ–≥–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.</div>
        <div class="sec"><b>Wheel</b> ‚Äî 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å.</div>
        <div class="sec"><b>Oracle</b> ‚Äî 1 —Ä–∞–∑ –≤ –¥–µ–Ω—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ (DAY/TON), –¥–∞–ª–µ–µ –¥–æ–ø. –ø–æ–ø—ã—Ç–∫–∞ –∑–∞ 1 TON (Mock).</div>
        <div class="sec"><b>Gate</b> ‚Äî —Å–Ω–∞—á–∞–ª–∞ Risk Gate, –ø–æ—Ç–æ–º ref-—Å—Å—ã–ª–∫–∞.</div>
        <div class="sec"><b>–í–∞–∂–Ω–æ:</b> –Ω–µ —Ñ–∏–Ω—Å–æ–≤–µ—Ç.</div>
      `;
    }
    if(state.lang==='zh'){
      return `
        <div class="sec"><b>‰∏ÄÂè•ËØùÔºö</b>‰ª™ÂºèÂåñ UI„ÄÇÂçñÁöÑÊòØËäÇÂ•è/‰ø°ÂøÉ/Áä∂ÊÄÅÔºå‰∏çÊòØ‚Äú‰ø°Âè∑‚Äù„ÄÇ</div>
        <div class="sec"><b>QK</b>ÔºöÁä∂ÊÄÅËÉΩÈáèÔºåÊù•Ëá™ Wheel/Oracle/Decision„ÄÇ</div>
        <div class="sec"><b>Flow Score (0‚Äì100)</b>ÔºöÂÜ≥Á≠ñÂÜ∑ÈùôÂ∫¶ÊåáÊ†á„ÄÇ</div>
        <div class="sec"><b>Market Weather</b>ÔºöCALM / BREEZE / HEAVY / STORM„ÄÇ</div>
        <div class="sec"><b>Risk Aura</b>ÔºöLOW / MED / HIGH„ÄÇGate ÂâçÁ°ÆËÆ§„ÄÇ</div>
        <div class="sec"><b>Wheel</b>ÔºöÊØèÂ§©‰∏ÄÊ¨°„ÄÇ</div>
        <div class="sec"><b>Oracle</b>ÔºöÊØèÂ§©‰∏ÄÊ¨°ÂÖçË¥πÔºåÈ¢ùÂ§ñ 1 Ê¨° 1 TONÔºàMockÔºâ„ÄÇ</div>
        <div class="sec"><b>Gate</b>ÔºöRisk Gate ‚Üí ref ÈìæÊé•„ÄÇ</div>
        <div class="sec"><b>Ê≥®ÊÑèÔºö</b>ÈùûÊäïËµÑÂª∫ËÆÆ„ÄÇ</div>
      `;
    }
    return `
      <div class="sec"><b>One-liner:</b> Ritualized UI. You sell rhythm/confidence/status ‚Äî not ‚Äúsignals‚Äù.</div>
      <div class="sec"><b>QK</b> status energy from Wheel/Oracle/Decisions.</div>
      <div class="sec"><b>Flow Score (0‚Äì100)</b> calm indicator.</div>
      <div class="sec"><b>Market Weather</b> narrative: CALM / BREEZE / HEAVY / STORM.</div>
      <div class="sec"><b>Risk Aura</b> LOW / MED / HIGH; Gate confirmation.</div>
      <div class="sec"><b>Wheel</b> 1/day.</div>
      <div class="sec"><b>Oracle</b> 1/day free, extra 1 for 1 TON (Mock).</div>
      <div class="sec"><b>Gate</b> Risk Gate ‚Üí ref link.</div>
      <div class="sec"><b>Note:</b> not financial advice.</div>
    `;
  }

  function openRules(){ $('rulesBody').innerHTML = rulesHTML(); $('rulesBack').style.display = 'flex'; }
  function closeRules(){ $('rulesBack').style.display = 'none'; }

  function openPaywall(){
    const html = `
      <div class="sec"><b>${t('payText1')}</b></div>
      <div class="sec">${t('payText2')}</div>
    `;
    $('payBody').innerHTML = html;
    $('payBack').style.display = 'flex';
  }
  function closePaywall(){ $('payBack').style.display = 'none'; }

  let riskConfirmed = false;
  function openRiskGate(){
    riskConfirmed = false;
    $('riskBody').innerHTML = `
      <div class="sec"><b>${t('riskText1')}</b></div>
      <div class="sec">${t('riskText2')}</div>
      <div class="sec">
        <span style="padding:8px 12px;border-radius:999px;border:1px solid rgba(255,211,106,.18);background:rgba(255,211,106,.08)">
          Risk Aura: <b>${state.risk}</b>
        </span>
      </div>
      <div class="sec">
        <label style="display:flex;gap:10px;align-items:center;cursor:pointer">
          <input id="riskCheck" type="checkbox" style="transform:scale(1.15)"/>
          <span>${t('riskAgree')}</span>
        </label>
      </div>
    `;
    $('riskBack').style.display = 'flex';
    setTimeout(()=>{
      const cb = $('riskCheck');
      if(cb) cb.addEventListener('change', ()=> riskConfirmed = cb.checked);
    },0);
  }
  function closeRiskGate(){ $('riskBack').style.display = 'none'; }
  function goGate(){
    if(!riskConfirmed) return;
    closeRiskGate();
    flash();
    setTimeout(()=> window.open(state.gate.refUrl, "_blank"), 520);
  }

  /* ===== Wheel ===== */
  const wheelCanvas = $('wheel');
  const wctx = wheelCanvas.getContext('2d');
  const luckSymbols = ["Á¶è","Á¶Ñ","ÂØø","Âñú","Ë¥¢","Âêâ","Á••","ÂÆâ","È°∫","Êó∫","Êòå","Áëû","Âæ∑","Âíå","ÂÖ¥"];

  function resizeWheel(){
    const rect = wheelCanvas.getBoundingClientRect();
    const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    wheelCanvas.width = Math.floor(rect.width * dpr);
    wheelCanvas.height = Math.floor(rect.height * dpr);
    wctx.setTransform(dpr,0,0,dpr,0,0);
  }

  function drawWheel(){
    const rect = wheelCanvas.getBoundingClientRect();
    const cx = rect.width/2, cy = rect.height/2;
    const R = Math.min(cx,cy)*0.92;
    const inner = R*0.18;

    wctx.clearRect(0,0,rect.width,rect.height);

    const ringGrad = wctx.createRadialGradient(cx,cy,R*0.4,cx,cy,R*1.02);
    ringGrad.addColorStop(0, "rgba(255,211,106,.08)");
    ringGrad.addColorStop(1, "rgba(255,43,63,.10)");
    wctx.fillStyle = ringGrad;
    wctx.beginPath(); wctx.arc(cx,cy,R*1.02,0,Math.PI*2); wctx.fill();

    const N = state.wheel.petals;
    const step = (Math.PI*2)/N;
    const angle0 = state.wheel.angle;

    for(let i=0;i<N;i++){
      const a1 = angle0 + i*step;
      const a2 = a1 + step;
      const alt = (i%2===0);
      const col1 = alt ? "rgba(180,0,29,.95)" : "rgba(255,43,63,.70)";
      const col2 = alt ? "rgba(255,43,63,.55)" : "rgba(180,0,29,.85)";
      const g = wctx.createLinearGradient(
        cx + Math.cos(a1)*R, cy + Math.sin(a1)*R,
        cx + Math.cos(a2)*R, cy + Math.sin(a2)*R
      );
      g.addColorStop(0, col1); g.addColorStop(1, col2);

      wctx.beginPath();
      wctx.moveTo(cx,cy);
      wctx.arc(cx,cy,R,a1,a2);
      wctx.closePath();
      wctx.fillStyle = g; wctx.fill();

      wctx.strokeStyle = "rgba(255,211,106,.28)";
      wctx.lineWidth = 1; wctx.stroke();

      const mid = (a1+a2)/2;
      const tx = cx + Math.cos(mid)*R*0.63;
      const ty = cy + Math.sin(mid)*R*0.63;

      wctx.save();
      wctx.translate(tx,ty);
      wctx.rotate(mid + Math.PI/2);
      wctx.font = `${Math.floor(R*0.16)}px ui-sans-serif`;
      wctx.fillStyle = "rgba(255,211,106,.95)";
      wctx.shadowColor = "rgba(0,0,0,.55)";
      wctx.shadowBlur = 10;
      wctx.textAlign = "center";
      wctx.textBaseline = "middle";
      wctx.fillText(luckSymbols[i], 0, 0);
      wctx.restore();
    }

    wctx.beginPath(); wctx.arc(cx,cy,R*0.40,0,Math.PI*2);
    wctx.fillStyle = "rgba(0,0,0,.35)"; wctx.fill();
    wctx.strokeStyle = "rgba(255,211,106,.18)"; wctx.lineWidth = 1; wctx.stroke();

    wctx.beginPath(); wctx.arc(cx,cy,inner,0,Math.PI*2);
    wctx.fillStyle = "rgba(0,0,0,.60)"; wctx.fill();
    wctx.strokeStyle = "rgba(255,211,106,.20)"; wctx.lineWidth = 1; wctx.stroke();
  }

  function computeWheelIndex(){
    const N = state.wheel.petals;
    const step = (Math.PI*2)/N;
    const pointer = 0;
    let a = (pointer - state.wheel.angle) % (Math.PI*2);
    if(a<0) a += Math.PI*2;
    return Math.floor(a/step);
  }

  function applyNarrativeFromFlow(){
    const fs = state.flowScore;
    if(fs >= 78){ state.weather = "CALM"; state.risk = "LOW"; }
    else if(fs >= 58){ state.weather = "BREEZE"; state.risk = "MED"; }
    else if(fs >= 40){ state.weather = "HEAVY"; state.risk = "MED"; }
    else { state.weather = "STORM"; state.risk = "HIGH"; }

    $('weather').textContent = state.weather;
    $('riskTag').textContent = `Risk Aura: ${state.risk}`;
    $('chipWeather').textContent = `Market Weather: ${state.weather}`;
    $('chipAura').textContent = `Risk Aura: ${state.risk}`;
    $('chipAura').classList.toggle('ok', state.risk === 'LOW');
    $('chipAura').classList.toggle('red', state.risk === 'HIGH');

    const fw = (state.risk === 'LOW') ? "OPEN" : (state.risk === 'MED' ? "NARROW" : "CLOSED");
    $('chipFlow').textContent = `Flow Window: ${fw}`;
    $('flowWindow').textContent = fw;
  }

  function startSpin(){
    const tk = dayKey();
    if(state.wheel.usedToday && state.today.key === tk){
      openRules();
      return;
    }
    if(state.wheel.spinning) return;

    state.wheel.usedToday = true;
    state.wheel.spinning = true;
    state.wheel.resultIndex = null;

    state.wheel.velocity = rnd(0.14, 0.18);
    state.wheel.friction = 0.987;
    state.wheel.stopEps = 0.0010;

    flash();
    saveState();
  }

  function wheelTick(){
    if(state.wheel.spinning){
      state.wheel.angle += state.wheel.velocity;
      state.wheel.velocity *= state.wheel.friction;
      state.wheel.velocity = clamp(state.wheel.velocity, 0, 0.22);

      if(state.wheel.velocity < state.wheel.stopEps){
        state.wheel.spinning = false;
        state.wheel.velocity = 0;
        state.wheel.resultIndex = computeWheelIndex();

        const gain = rnd(2.2, 6.6);
        state.qk = +(state.qk + gain).toFixed(2);
        state.flowScore = clamp(Math.round(state.flowScore + rnd(-6, +8)), 0, 100);

        applyNarrativeFromFlow();
        flash();

        pushJournal({ type:"wheel", title:`Wheel ‚Üí ${luckSymbols[state.wheel.resultIndex]}`, detail:`+${gain.toFixed(2)} QK` });
        enableChoicesIfOracleReady();
        saveState();
        renderHUD();
      }
    }
    drawWheel();
    requestAnimationFrame(wheelTick);
  }

  /* ===== Oracle ===== */
  const oracleBank = {
    ru: {
      dayPos:[
        "–£–¥–∞—á–∞ —Ä—è–¥–æ–º. –£–ø—Ä–æ—Å—Ç–∏—à—å –¥–µ–Ω—å ‚Äî –≤—ã–∏–≥—Ä–∞–µ—à—å: —Å–¥–µ–ª–∞–π –æ–¥–Ω—É –≥–ª–∞–≤–Ω—É—é –∑–∞–¥–∞—á—É –∏ –ø–æ–ª—É—á–∏—à—å –∏–º–ø—É–ª—å—Å.",
        "–î–µ–Ω—å —Ä–æ–≤–Ω—ã–π. –ù–µ —Å–ø–µ—à–∏: —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å = –ø–æ–±–µ–¥–∞.",
        "–°—Ç—Ä–∞—Ç–µ–≥–∏—è ‚Äú–º–µ–Ω—å—à–µ, –Ω–æ –ª—É—á—à–µ‚Äù: –º–µ–Ω—å—à–µ –¥–µ–π—Å—Ç–≤–∏–π, –±–æ–ª—å—à–µ –∫–∞—á–µ—Å—Ç–≤–∞."
      ],
      dayCaution:[
        "–°–µ–≥–æ–¥–Ω—è –ª—É—á—à–µ —É–¥–µ—Ä–∂–∞—Ç—å—Å—è, —á–µ–º –¥–∞–≤–∏—Ç—å. –ë–µ–∑ –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π ‚Äî –≤–µ—á–µ—Ä–æ–º —è—Å–Ω–µ–µ.",
        "–î–µ–Ω—å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏: –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–π –ø–æ—Ç–æ–∫."
      ],
      tonPos:[
        "–ü–æ—Ç–æ–∫ —Ä–æ–≤–Ω—ã–π. –ï—Å–ª–∏ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å ‚Äî –º–∞–ª–µ–Ω—å–∫–∏–π —Ä–∞–∑–º–µ—Ä, –≤—Ö–æ–¥ —á–∞—Å—Ç—è–º–∏.",
        "–°–º–æ—Ç—Ä–∏ Risk Aura: LOW/MED ‚Üí –ª—ë–≥–∫–∏–π –≤—Ö–æ–¥. HIGH ‚Üí –∂–¥–∞—Ç—å."
      ],
      tonCaution:[
        "–õ—É—á—à–µ –Ω–∞–±–ª—é–¥–∞—Ç—å. –ï—Å–ª–∏ Risk Aura HIGH ‚Äî —Ç–æ–ª—å–∫–æ –∑–∞–º–µ—Ç–∫–∏, –±–µ–∑ –¥–µ–π—Å—Ç–≤–∏–π.",
        "–®—É–º–Ω—ã–π –ø–æ—Ç–æ–∫: –±–µ–∑ —Ç—è–∂—ë–ª–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∏ —á–∞—Å—Ç—ã—Ö –≤—Ö–æ–¥–æ–≤/–≤—ã—Ö–æ–¥–æ–≤."
      ]
    },
    en: {
      dayPos:[
        "Prosperity is near. Keep it simple: one top task ‚Äî momentum follows.",
        "Stable day. Don‚Äôt rush. Steady is winning.",
        "Less but better: do fewer things, do them right."
      ],
      dayCaution:[
        "Better to hold than push today. Avoid impulsive moves; review later.",
        "Caution wins: avoid conflict, keep the flow."
      ],
      tonPos:[
        "Wealth flow is steady. If you act: small size, split entries.",
        "Check Risk Aura first: LOW/MED ‚Üí small steps. HIGH ‚Üí wait."
      ],
      tonCaution:[
        "Better to observe. If Risk Aura is HIGH, record notes ‚Äî no action.",
        "Flow is noisy: avoid heavy size and over-trading."
      ]
    },
    zh: {
      dayPos:[
        "ÊÅ≠ÂñúÁôºË≤°„ÄÇÂÖàÂÆåÊàê‰∏Ä‰ª∂ÊúÄÈáçË¶ÅÁöÑ‰∫ãÔºåÁ¶èÊ∞î‰ºöÈ°∫ÂäøËÄåÊù•„ÄÇ",
        "ËäÇÂ•èÂÅèÁ®≥ÔºåÂà´ÊÄ•ÔºåÁ®≥Â∞±ÊòØËµ¢„ÄÇ",
        "Â∞ëÂÅö‰ΩÜÂÅöÂØπÔºöÂ∞ëËÄåÁ≤æ„ÄÇ"
      ],
      dayCaution:[
        "‰ªäÊó•ÂÆúÂÆà‰∏çÂÆúÊîª„ÄÇÂ∞ëÂÅöÂÜ≤Âä®ÂÜ≥ÂÆöÔºåÊôö‰∏äÂ§çÁõòÊõ¥Ê∏ÖÊô∞„ÄÇ",
        "Ë∞®ÊÖé‰∏∫‰∏ä„ÄÇÈÅøÂÖç‰∫âËæ©ÔºåÁïôÈù¢Â≠ê„ÄÇ"
      ],
      tonPos:[
        "TON Ê∞îÂú∫Âπ≥Á®≥ÔºöÂ∞è‰ªì‰Ωç„ÄÅÂàÜÊâπÊõ¥‰Ω≥„ÄÇ",
        "ÂÖàÁúã Risk AuraÔºöLOW/MED Â∞èÊ≠•ËøõÂÖ•ÔºåHIGH ÂÖàÁ≠âÂæÖ„ÄÇ"
      ],
      tonCaution:[
        "‰ªäÊó•ÂÆúËßÇÊúõ„ÄÇRisk Aura HIGH Âè™ËÆ∞ÂΩï‰∏çÊìç‰Ωú„ÄÇ",
        "Ê∞îÂú∫ÂÅè‰π±„ÄÇÈÅøÂÖçÈáç‰ªì‰∏éÈ¢ëÁπÅËøõÂá∫„ÄÇ"
      ]
    }
  };

  function canUseOracle(){
    if(state.today.key !== dayKey()){
      state.today.key = dayKey();
      state.today.oracleUsed = false;
      state.today.oraclePaidExtra = 0;
    }
    return !state.today.oracleUsed || state.today.oraclePaidExtra > 0;
  }
  function consumeOracleUse(){
    if(!state.today.oracleUsed){ state.today.oracleUsed = true; return true; }
    if(state.today.oraclePaidExtra > 0){ state.today.oraclePaidExtra -= 1; return true; }
    return false;
  }

  function oracleGenerate(){
    const bank = oracleBank[state.lang] || oracleBank.en;
    const type = state.oracle.type;
    const isCaution = Math.random() < 0.10;

    const arr = (type==='day')
      ? (isCaution ? bank.dayCaution : bank.dayPos)
      : (isCaution ? bank.tonCaution : bank.tonPos);

    const text = arr[irnd(0, arr.length-1)];

    let suggested = "WAIT";
    if(state.risk === "LOW" && !isCaution) suggested = "ENTER";
    else if(state.risk === "HIGH" || isCaution) suggested = "SKIP";

    const stamp = `${state.today.key} ‚Ä¢ ${nowHM()} ‚Ä¢ ${type.toUpperCase()}`;
    return { text, isCaution, suggested, stamp, aura:state.risk, weather:state.weather, type };
  }

  function enableChoicesIfOracleReady(){
    const ok = !!state.oracle.last;
    $('btnEnter').disabled = !ok;
    $('btnWait').disabled = !ok;
    $('btnSkip').disabled = !ok;
  }

  function setOracleUI(o){
    $('oracleStamp').textContent = o.stamp;
    $('oracleBody').textContent = o.text;

    $('chipWeather').textContent = `Market Weather: ${o.weather}`;
    $('chipAura').textContent = `Risk Aura: ${o.aura}`;
    $('chipAura').classList.toggle('ok', o.aura === 'LOW' && !o.isCaution);
    $('chipAura').classList.toggle('red', o.aura === 'HIGH' || o.isCaution);

    const fw = (o.aura === 'LOW') ? "OPEN" : (o.aura === 'MED' ? "NARROW" : "CLOSED");
    $('chipFlow').textContent = `Flow Window: ${fw}`;

    $('oracleHead').textContent = `${t('oracleHead')} ‚Ä¢ ${o.suggested}`;
  }

  function runOracle(){
    if(!canUseOracle() || !consumeOracleUse()){
      openPaywall();
      return;
    }
    const o = oracleGenerate();
    state.oracle.last = o;
    state.oracle.decision = null;

    const gain = o.isCaution ? rnd(0.6, 1.8) : rnd(1.2, 3.6);
    state.qk = +(state.qk + gain).toFixed(2);

    if(o.isCaution) state.today.neg += 1; else state.today.pos += 1;

    setOracleUI(o);
    enableChoicesIfOracleReady();
    flash();

    pushJournal({ type:"oracle", title:`Oracle (${o.type.toUpperCase()}) ‚Üí ${o.suggested}`, detail:o.isCaution ? t('caution') : "Positive" });
    saveState();
    renderHUD();
  }

  function takeDecision(dec){
    if(!state.oracle.last) return;
    state.oracle.decision = dec;

    let delta = 0;
    if(dec==='ENTER'){
      delta = (state.risk==='HIGH') ? rnd(-2.0, 0.8) : rnd(1.0, 4.0);
    } else if(dec==='WAIT'){
      delta = rnd(0.4, 2.4);
    } else {
      delta = rnd(0.8, 2.2);
    }

    state.qk = +(state.qk + delta).toFixed(2);
    flash();
    pushJournal({ type:"decision", title:`Decision ‚Üí ${dec}`, detail:`QK ${delta>=0?'+':''}${delta.toFixed(2)}` });
    renderHUD();
    saveState();
  }

  /* ===== Journal ===== */
  function pushJournal(entry){
    const line = { date: state.today.key, time: nowHM(), type: entry.type, title: entry.title, detail: entry.detail };
    state.journal.unshift(line);
    if(state.journal.length > 7) state.journal.pop();
    renderJournal();
  }

  function renderJournal(){
    if(state.journal.length === 0){
      $('journal').textContent = t('noRecords');
      return;
    }
    const lines = state.journal.map(j => {
      const icon = (j.type==='wheel') ? "üé°" : (j.type==='oracle' ? "üßø" : "‚ü†");
      return `${icon} ${j.date} ${j.time} ‚Äî ${j.title} ‚Ä¢ ${j.detail}`;
    });
    $('journal').textContent = lines.join("\n");
  }

  /* ===== HUD ===== */
  const seals = {
    ru: ["–ü–ï–ß–ê–¢–¨ –î–û–°–¢–ê–¢–ö–ê","–ü–ï–ß–ê–¢–¨ –ë–õ–ê–ì–û–°–õ–û–í–ï–ù–ò–Ø","–ü–ï–ß–ê–¢–¨ –î–†–ê–ö–û–ù–ê","–í–ï–ß–ù–ê–Ø –£–î–ê–ß–ê","–ü–ï–ß–ê–¢–¨ –ü–û–¢–û–ö–ê"],
    en: ["SEAL OF PROSPERITY","SEAL OF BLESSING","DRAGON GUARD SEAL","ETERNAL FORTUNE","FLOWFAVORED SEAL"],
    zh: ["‰ªäÊó•Ë¥¢Âç∞","Â§©ËµêÁ¶èÂç∞","ÈáëÈæôÊä§Âç∞","ÂØåË¥µÈïøÊòé","Á¶èËøêÁõ∏Èöè"]
  };

  function pickDailySeal(){
    const k = state.today.key;
    let hash = 0; for(const c of k) hash = (hash*31 + c.charCodeAt(0))>>>0;
    const arr = seals[state.lang] || seals.en;
    $('dailySeal').textContent = arr[hash % arr.length];
  }

  function renderHUD(){
    $('qk').textContent = state.qk.toFixed(2);
    $('flowScore').textContent = String(state.flowScore);
    $('weather').textContent = state.weather;

    const qk = state.qk;
    $('qkTag').textContent = (qk >= 140) ? "VIP READY" : (qk >= 80 ? "RISING" : "BALANCED");

    $('riskTag').textContent = `Risk Aura: ${state.risk}`;
    $('posCount').textContent = String(state.today.pos);
    $('negCountTag').textContent = `${t('caution')}: ${state.today.neg}`;

    $('socialA').textContent = state.social.a.toLocaleString();
    $('socialB').textContent = `VIP: ${state.social.vip}`;

    $('streak').textContent = String(state.streak);
    $('cycleTag').textContent = "7/21/49 Path";

    const pulse = (state.flowScore>=60) ? `+${rnd(.2,1.8).toFixed(2)}%` : `-${rnd(.1,1.2).toFixed(2)}%`;
    $('tonPulse').textContent = pulse;
    $('liqPulse').textContent = `Liquidity: ${(state.risk==='HIGH')?'Thin':'Steady'}`;
    $('vol').textContent = (state.risk==='HIGH') ? rnd(16,28).toFixed(1) : rnd(7,15).toFixed(1);
    $('trend').textContent = `Trend: ${(state.flowScore>55)?'Up':'Mixed'}`;
    $('flowWindow').textContent = (state.risk==='LOW')?'OPEN':(state.risk==='MED')?'NARROW':'CLOSED';

    const used = state.today.oracleUsed ? 1 : 0;
    $('limitText').textContent = `${used} / day`;

    pickDailySeal();
    applyNarrativeFromFlow();
    renderJournal();
  }

  /* ===== Lucky Hour ===== */
  function isWithinWindow(d, baseHour, windowMinutes){
    const start = new Date(d);
    start.setHours(baseHour,0,0,0);
    const end = new Date(start.getTime() + windowMinutes*60*1000);
    return d >= start && d <= end;
  }

  function computeLucky(){
    const d = new Date();
    const {morningHour, eveningHour, windowMinutes} = state.lucky;
    const inMorning = isWithinWindow(d, morningHour, windowMinutes);
    const inEvening = isWithinWindow(d, eveningHour, windowMinutes);
    state.lucky.isLuckyNow = inMorning || inEvening;

    const todayMorning = new Date(d); todayMorning.setHours(morningHour,0,0,0);
    const todayEvening = new Date(d); todayEvening.setHours(eveningHour,0,0,0);
    const tomorrowMorning = new Date(d); tomorrowMorning.setDate(d.getDate()+1); tomorrowMorning.setHours(morningHour,0,0,0);

    let nextStart = null;
    if(d < todayMorning) nextStart = todayMorning;
    else if(d < todayEvening) nextStart = todayEvening;
    else nextStart = tomorrowMorning;

    const diff = Math.max(0, nextStart - d);
    state.lucky.nextLuckyIn = diff;

    document.body.classList.toggle('luckyHour', state.lucky.isLuckyNow);

    const hh = Math.floor(diff/3600000);
    const mm = Math.floor((diff%3600000)/60000);
    const ss = Math.floor((diff%60000)/1000);
    $('luckyCountdown').textContent = `‚Ä¢ Next Lucky Hour ${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
    $('windowTimer').textContent = `Next: ${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
  }

  function tickClock(){
    $('localTime').textContent = nowHMS();
    computeLucky();
    setTimeout(tickClock, 250);
  }

  /* ===== Mode + Lang ===== */
  function setMode(mode){
    state.mode = mode;
    $('btnRitual').classList.toggle('active', mode==='ritual');
    $('btnPro').classList.toggle('active', mode==='pro');
    $('proCard').style.display = (mode==='pro') ? 'block' : 'none';
    saveState();
  }

  function setLang(lang){
    state.lang = lang;
    applyI18n();
    buildOrbits();          // IMPORTANT: planet names translated
    renderHUD();
    saveState();
  }

  function setForecastType(type){
    state.oracle.type = type;
    $('btnForecastDay').classList.toggle('active', type==='day');
    $('btnForecastTON').classList.toggle('active', type==='ton');
    saveState();
  }

  function mockPay(){
    state.today.oraclePaidExtra += 1;
    closePaywall();
    flash();
    saveState();
  }

  /* ===== Dock icon spin ===== */
  function spinDockIcon(btn, dir='R'){
    const icon = btn.querySelector('.dockIcon');
    if(!icon) return;
    icon.classList.remove('spinL','spinR');
    void icon.offsetWidth;
    icon.classList.add(dir==='L'?'spinL':'spinR');
    setTimeout(()=>icon.classList.remove('spinL','spinR'), 1100);
  }

  /* ===== Events ===== */
  function bindEvents(){
    $('btnBang').addEventListener('click', toggleBang);

    $('helpBtn').addEventListener('click', openRules);
    $('btnRules').addEventListener('click', openRules);
    $('dockRules').addEventListener('click', ()=>{ spinDockIcon($('dockRules'),'L'); openRules(); });

    $('rulesClose').addEventListener('click', closeRules);
    $('rulesOk').addEventListener('click', closeRules);
    $('rulesBack').addEventListener('click', (e)=>{ if(e.target.id==='rulesBack') closeRules(); });

    $('btnRitual').addEventListener('click', ()=> setMode('ritual'));
    $('btnPro').addEventListener('click', ()=> setMode('pro'));

    $('btnZH').addEventListener('click', ()=> setLang('zh'));
    $('btnEN').addEventListener('click', ()=> setLang('en'));
    $('btnRU').addEventListener('click', ()=> setLang('ru'));

    $('btnForecastDay').addEventListener('click', ()=> setForecastType('day'));
    $('btnForecastTON').addEventListener('click', ()=> setForecastType('ton'));

    $('btnSpin').addEventListener('click', startSpin);
    $('btnOracle').addEventListener('click', runOracle);
    $('btnGate').addEventListener('click', ()=>{
      if(!state.oracle.last){ openRules(); return; }
      openRiskGate();
    });

    $('btnEnter').addEventListener('click', ()=> takeDecision('ENTER'));
    $('btnWait').addEventListener('click', ()=> takeDecision('WAIT'));
    $('btnSkip').addEventListener('click', ()=> takeDecision('SKIP'));

    $('dockRitual').addEventListener('click', ()=>{
      spinDockIcon($('dockRitual'),'R');
      window.scrollTo({top:0, behavior:'smooth'});
    });
    $('dockWheel').addEventListener('click', ()=>{
      spinDockIcon($('dockWheel'),'R');
      const y = $('wheel').getBoundingClientRect().top + window.scrollY - 90;
      window.scrollTo({top:y, behavior:'smooth'});
    });
    $('dockOracle').addEventListener('click', ()=>{
      spinDockIcon($('dockOracle'),'L');
      const y = $('oraclePanel').getBoundingClientRect().top + window.scrollY - 90;
      window.scrollTo({top:y, behavior:'smooth'});
    });
    $('dockGate').addEventListener('click', ()=>{
      spinDockIcon($('dockGate'),'R');
      if(!state.oracle.last){ openRules(); return; }
      openRiskGate();
    });

    $('payClose').addEventListener('click', closePaywall);
    $('payLater').addEventListener('click', closePaywall);
    $('payMock').addEventListener('click', mockPay);
    $('payBack').addEventListener('click', (e)=>{ if(e.target.id==='payBack') closePaywall(); });

    $('riskClose').addEventListener('click', closeRiskGate);
    $('riskCancel').addEventListener('click', closeRiskGate);
    $('riskGo').addEventListener('click', goGate);
    $('riskBack').addEventListener('click', (e)=>{ if(e.target.id==='riskBack') closeRiskGate(); });

    window.addEventListener('resize', resizeWheel);
  }

  /* ===== Init ===== */
  loadState();

  if(state.today.key !== dayKey()){
    state.today.key = dayKey();
    state.today.pos = irnd(6,12);
    state.today.neg = irnd(0,2);
    state.today.oracleUsed = false;
    state.today.oraclePaidExtra = 0;
    state.wheel.usedToday = false;
  }

  setMode(state.mode || 'ritual');
  applyNarrativeFromFlow();

  applyI18n();
  buildOrbits();

  resizeWheel();
  renderHUD();
  bindEvents();
  tickClock();
  wheelTick();

  </script>

  <!-- Three.js background (optional, behind UI and not clickable) -->
  <script type="module">
    import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";

    const canvas = document.getElementById("webgl");
    const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true, powerPreference:"high-performance" });
    renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(48, window.innerWidth/window.innerHeight, 0.1, 200);
    camera.position.set(0, 2.4, 9.2);

    const key = new THREE.DirectionalLight(0xffd36a, 1.2);
    key.position.set(4, 8, 6);
    scene.add(key);

    const rim = new THREE.DirectionalLight(0xffffff, 0.55);
    rim.position.set(-6, 3, -4);
    scene.add(rim);

    const amb = new THREE.AmbientLight(0x2a1c08, 0.9);
    scene.add(amb);

    const gold = new THREE.MeshStandardMaterial({ color:0xffd36a, metalness:1.0, roughness:0.18, emissive:0x1a0f00, emissiveIntensity:0.25 });
    const obsidian = new THREE.MeshStandardMaterial({ color:0x040405, metalness:0.45, roughness:0.35, emissive:0x000000, emissiveIntensity:0.2 });
    const crimson = new THREE.MeshStandardMaterial({ color:0xb8001d, metalness:0.35, roughness:0.35, emissive:0x2a0008, emissiveIntensity:0.45 });

    const floor = new THREE.Mesh(new THREE.CircleGeometry(18, 64), obsidian);
    floor.rotation.x = -Math.PI/2;
    floor.position.y = -0.02;
    scene.add(floor);

    const colGeo = new THREE.CylinderGeometry(0.28, 0.34, 4.2, 24);
    for(let i=0;i<8;i++){
      const a = (i/8)*Math.PI*2;
      const x = Math.cos(a)*4.8;
      const z = Math.sin(a)*4.8;
      const col = new THREE.Mesh(colGeo, obsidian);
      col.position.set(x, 2.05, z);
      scene.add(col);

      const cap = new THREE.Mesh(new THREE.TorusGeometry(0.45, 0.08, 16, 48), gold);
      cap.position.set(x, 4.18, z);
      cap.rotation.x = Math.PI/2;
      scene.add(cap);
    }

    const ring = new THREE.Mesh(new THREE.TorusGeometry(1.6, 0.12, 24, 96), gold);
    ring.position.set(0, 2.0, 0);
    scene.add(ring);

    const core = new THREE.Mesh(new THREE.CircleGeometry(0.86, 64), crimson);
    core.position.set(0, 2.0, 0.01);
    scene.add(core);

    const glowPlane = new THREE.Mesh(
      new THREE.PlaneGeometry(6.2, 6.2),
      new THREE.MeshBasicMaterial({ color:0xffd36a, transparent:true, opacity:0.06 })
    );
    glowPlane.position.set(0,2.0,0);
    scene.add(glowPlane);

    const dustCount = 700;
    const dustPos = new Float32Array(dustCount*3);
    for(let i=0;i<dustCount;i++){
      dustPos[i*3+0] = (Math.random()-0.5)*16;
      dustPos[i*3+1] = Math.random()*8;
      dustPos[i*3+2] = (Math.random()-0.5)*16;
    }
    const dustGeo = new THREE.BufferGeometry();
    dustGeo.setAttribute("position", new THREE.BufferAttribute(dustPos, 3));
    const dustMat = new THREE.PointsMaterial({ color:0xffd36a, size:0.035, transparent:true, opacity:0.65 });
    const dust = new THREE.Points(dustGeo, dustMat);
    scene.add(dust);

    const meteorGeo = new THREE.IcosahedronGeometry(0.18, 1);
    const meteors = [];
    function spawnMeteor(){
      const m = new THREE.Mesh(meteorGeo, gold);
      const fromLeft = Math.random() < 0.5;
      m.position.set(fromLeft? -10: 10, 1.2 + Math.random()*4.8, (Math.random()-0.5)*8);
      m.userData.vx = fromLeft? (0.012+Math.random()*0.018) : -(0.012+Math.random()*0.018);
      m.userData.vy = (Math.random()-0.5)*0.004;
      m.userData.vz = (Math.random()-0.5)*0.006;
      m.userData.spin = (Math.random()-0.5)*0.05;
      scene.add(m);
      meteors.push(m);
      if(meteors.length > 18){
        const old = meteors.shift();
        scene.remove(old);
      }
    }
    setInterval(spawnMeteor, 1400);

    function applyLuckyVisual(){
      const lucky = document.body.classList.contains("luckyHour");
      dustMat.opacity = lucky ? 0.95 : 0.65;
      glowPlane.material.opacity = lucky ? 0.10 : 0.06;
      core.material.emissiveIntensity = lucky ? 0.85 : 0.45;
    }

    let t0 = performance.now();
    function animate(t){
      const dt = Math.min(40, t - t0);
      t0 = t;

      const breath = Math.sin(t*0.0006)*0.12;
      camera.position.x = breath;
      camera.lookAt(0, 2.0, 0);

      ring.rotation.z += 0.0028;
      ring.rotation.x = Math.sin(t*0.0007)*0.04;

      const pulse = 0.55 + 0.45*Math.sin(t*0.0012);
      core.scale.setScalar(1.0 + pulse*0.02);

      const arr = dustGeo.attributes.position.array;
      for(let i=0;i<dustCount;i++){
        arr[i*3+1] += 0.0022 + (document.body.classList.contains("luckyHour")?0.0012:0);
        arr[i*3+0] += Math.sin((t*0.0002)+(i*0.01))*0.00035;
        if(arr[i*3+1] > 9) arr[i*3+1] = 0;
      }
      dustGeo.attributes.position.needsUpdate = true;

      for(const m of meteors){
        m.position.x += m.userData.vx * (dt*0.06);
        m.position.y += m.userData.vy * (dt*0.06);
        m.position.z += m.userData.vz * (dt*0.06);
        m.rotation.y += m.userData.spin;
        if(m.position.x < -12 || m.position.x > 12) scene.remove(m);
      }

      applyLuckyVisual();
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }
    requestAnimationFrame(animate);

    window.addEventListener("resize", ()=>{
      renderer.setSize(window.innerWidth, window.innerHeight);
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
    });
  </script>
</body>
</html>
